<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="robots" content="noindex, nofollow">
    
    <title>Mission Control ‚Äì Remembered</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- DESIGN (Original restored) --- */
        body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-serif-custom { font-family: 'Playfair Display', serif; }
        .text-gold { color: #EAB308 !important; }
        .bg-gold { background-color: #EAB308; }
        
        /* PREMIUM GLOW */
        .glass-panel { background: rgba(10, 10, 10, 0.8); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; backdrop-filter: blur(20px); box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4); }
        .btn-glow-gold { background: linear-gradient(to bottom right, #EAB308, #CA8A04); border: 1px solid #EAB308; box-shadow: 0 0 20px rgba(234, 179, 8, 0.4); transition: all 0.3s ease; }
        .btn-glow-gold:hover { box-shadow: 0 0 40px rgba(234, 179, 8, 0.8); transform: scale(1.02); }
        .btn-glow-white { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .btn-glow-white:hover { border-color: #FFF; background: rgba(255,255,255,0.1); }
        .btn-glow-red { background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.4); color: #EF4444; }
        .btn-glow-red:hover { border-color: #EF4444; box-shadow: 0 0 15px rgba(220, 38, 38, 0.2); }

        /* NAVIGATION & STATS */
        .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; cursor: pointer; }
        .nav-item.active { border-left: 3px solid #EAB308; background: linear-gradient(90deg, rgba(234, 179, 8, 0.1) 0%, rgba(0, 0, 0, 0) 100%); color: #EAB308; }
        .stat-value { font-size: 2.5rem; font-weight: 900; line-height: 1; }
        .stat-label { font-size: 0.7rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 0.5rem; }
        
        /* TABLE STYLES */
        .table-row-glow { transition: all 0.3s ease; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .table-row-glow:hover { background: rgba(255, 255, 255, 0.03); }
        .badge-netflix { background: rgba(229, 9, 20, 0.2); color: #E50914; border: 1px solid rgba(229, 9, 20, 0.3); }
        .badge-spotify { background: rgba(29, 185, 84, 0.2); color: #1DB954; border: 1px solid rgba(29, 185, 84, 0.3); }
        .badge-default { background: rgba(255, 255, 255, 0.1); color: #aaa; border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        .drop-zone { border: 2px dashed rgba(234, 179, 8, 0.2); background: rgba(0, 0, 0, 0.5); }
    </style>
</head>

<body class="flex h-screen bg-black">

    <aside class="w-64 border-r border-white/5 flex flex-col bg-black h-full">
        <div class="h-16 flex items-center px-6 border-b border-white/5">
            <div class="h-2 w-2 bg-yellow-500 rounded-full mr-3 shadow-[0_0_10px_#EAB308]"></div>
            <span class="text-yellow-500 font-bold tracking-[0.2em] text-xs">MISSION CONTROL</span>
        </div>

        <nav class="flex-1 py-8 space-y-2 px-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active w-full px-4 py-3 text-left text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üìä</span> Dashboard
            </button>
            <button onclick="switchTab('manage')" id="nav-manage" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üé¨</span> Manage Content
            </button>
            <button onclick="switchTab('add')" id="nav-add" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">‚ûï</span> Add / Edit
            </button>
            <button onclick="switchTab('inbox')" id="nav-inbox" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üì•</span> Suggestions
            </button>
            <button onclick="switchTab('users')" id="nav-users" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üë•</span> User Management
            </button>
            <button onclick="switchTab('campaigns')" id="nav-campaigns" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üì¢</span> Campaigns
            </button>
            <button onclick="switchTab('playlists')" id="nav-playlists" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üéµ</span> Playlists
            </button>
        </nav>

        <div class="p-6 text-xs text-gray-700 font-mono mt-auto border-t border-white/5">
            Build 14.2 (Restored)<br>
            <span class="text-green-900">‚óè Database Linked</span>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-black h-full overflow-hidden">
        <header class="h-16 min-h-[64px] flex items-center justify-between px-8 border-b border-white/5 bg-black z-10">
            <h1 id="page-title" class="text-2xl font-serif-custom font-bold text-white tracking-wide">System Overview</h1>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Status</div>
                    <div class="text-xs text-green-500 font-bold tracking-widest">ONLINE</div>
                </div>
                <div class="h-10 w-10 rounded-full bg-yellow-500/10 flex items-center justify-center border border-yellow-500/50">
                    <div class="h-2 w-2 bg-yellow-500 rounded-full animate-pulse"></div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative">

            <div id="tab-dashboard" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-panel p-8">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-blue-500/10 rounded-xl text-blue-500">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            </div>
                            <span class="text-xs text-green-500 bg-green-500/10 px-3 py-1 rounded-full font-bold">‚Üó Live</span>
                        </div>
                        <div class="stat-value text-white" id="stat-legends">--</div>
                        <div class="stat-label">Total Legends</div>
                    </div>
                    <div class="glass-panel p-8">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-red-500/10 rounded-xl text-red-500"><span class="text-3xl">ü•Ä</span></div>
                            <span class="text-xs text-red-500 bg-red-500/10 px-3 py-1 rounded-full font-bold">Club 27</span>
                        </div>
                        <div class="stat-value text-white" id="stat-club27">--</div>
                        <div class="stat-label">Club 27 Entries</div>
                    </div>
                    <div class="glass-panel p-8">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-orange-500/10 rounded-xl text-orange-500">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path></svg>
                            </div>
                            <span class="text-xs text-purple-500 bg-purple-500/10 px-3 py-1 rounded-full font-bold">+12.5%</span>
                        </div>
                        <div class="stat-value text-yellow-500" id="stat-suggestions">--</div>
                        <div class="stat-label">Pending Ideas</div>
                    </div>
                </div>
                <div class="glass-panel p-8">
                    <h3 class="font-serif-custom text-2xl font-bold text-white mb-6">Traffic Overview</h3>
                    <div class="w-full h-64"><canvas id="candleChart"></canvas></div>
                </div>
            </div>

            <div id="tab-manage" class="hidden h-full flex flex-col">
                <div class="flex justify-end items-center mb-6">
                    <button onclick="switchTab('add'); resetForm();" class="btn-glow-gold text-black px-6 py-3 rounded-xl font-bold text-sm uppercase tracking-wider flex items-center gap-2">CREATE NEW</button>
                </div>
                <div class="flex gap-1 mb-6 border-b border-white/10">
                    <button onclick="setActiveTable('legends')" id="table-tab-legends" class="tab-btn active">Legends</button>
                    <button onclick="setActiveTable('club27')" id="table-tab-club27" class="tab-btn">Club 27</button>
                </div>
                <div class="glass-panel overflow-hidden flex-1 rounded-xl border border-white/10">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-white/5 text-xs uppercase font-bold text-gray-500 sticky top-0 backdrop-blur-md z-10">
                                <tr>
                                    <th class="p-4 w-20">Image</th><th class="p-4">Name</th><th class="p-4">Category</th><th class="p-4">Partner</th><th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="legends-table-body" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-inbox" class="hidden">
                <div class="glass-panel overflow-hidden rounded-xl border border-white/10">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-white/5 text-xs uppercase font-bold text-gray-500"><tr><th class="p-4">Name</th><th class="p-4">Category</th><th class="p-4">Date</th><th class="p-4 text-right">Actions</th></tr></thead>
                        <tbody id="suggestions-table" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-add" class="hidden pb-20">
                <div class="max-w-5xl mx-auto glass-panel p-8 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center mb-6 pb-6 border-b border-white/5">
                        <h2 id="form-title" class="text-3xl font-serif-custom font-bold text-white">Add New Legend</h2>
                        <button onclick="resetForm()" class="text-xs text-gray-500 hover:text-gold underline transition">Clear Form</button>
                    </div>
                    <input type="hidden" id="edit-id" value=""><input type="hidden" id="edit-table" value="legends"><input type="hidden" id="existing-image-url" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Full Name *</label><input id="name" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="e.g. Michael Jackson" /></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Category</label><select id="category" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none"><option value="Music">Music</option><option value="Actor">Actor</option><option value="Comedian">Comedian</option><option value="Sport">Sport</option><option value="Visionary">Visionary</option><option value="Royal">Royal</option><option value="Fashion Icon">Fashion Icon</option></select></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Slug</label><input id="slug" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Born</label><input id="born" type="text" placeholder="1958 - 2009" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Death</label><input id="death" type="date" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                            </div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Headline</label><input id="headline" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Quote</label><input id="quote" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                        </div>
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block">Profile Image</label>
                                <div id="drop-area" class="drop-zone w-full h-40 rounded-xl flex flex-col items-center justify-center cursor-pointer relative overflow-hidden group">
                                    <input type="file" id="fileElem" accept="image/*" class="hidden" onchange="handleFiles(this.files)">
                                    <div id="drop-content" class="text-center"><p class="text-sm text-gray-300 font-medium">Click to upload or drag JPG</p></div>
                                    <div id="preview-container" class="absolute inset-0 bg-black hidden flex items-center justify-center"><img id="preview-img" class="h-full w-full object-cover opacity-50" /></div>
                                </div>
                            </div>
                            <div class="bg-gold/5 p-6 rounded-xl border border-gold/20 space-y-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">1. Trailer URL</label><input id="trailer_url" type="text" class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm focus:border-gold focus:outline-none" /></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">2. Partner</label><select id="partner_type" class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm"><option value="netflix">Netflix</option><option value="disney">Disney+</option></select></div>
                                    <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">3. Link</label><input id="streaming_url" type="text" class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm" /></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-1 md:col-span-2 space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Biography</label><textarea id="bio" rows="6" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none"></textarea></div>
                    </div>
                    <div class="mt-8 flex justify-end gap-4 border-t border-white/10 pt-6">
                        <button onclick="saveLegend()" id="save-btn" class="btn-glow-gold text-black font-bold py-4 px-10 rounded-lg flex items-center gap-2 uppercase text-sm tracking-wider">SAVE LEGEND</button>
                    </div>
                </div>
            </div>

            <div id="tab-users" class="hidden h-full flex flex-col" style="justify-content: flex-start;">
                <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                    <h3 class="text-lg font-bold text-white mb-4">User Plan Feature Matrix</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-black/40 border border-white/10 rounded-lg p-4"><h4 class="text-white font-bold">FREE</h4><span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">$0</span></div>
                        <div class="bg-gold/5 border border-gold/30 rounded-lg p-4"><h4 class="text-gold font-bold">SUPPORTER</h4><span class="text-xs text-gold bg-gold/20 px-2 py-1 rounded">$1.99</span></div>
                        <div class="bg-blue-900/10 border border-blue-500/30 rounded-lg p-4"><h4 class="text-blue-400 font-bold">LEGACY+</h4><span class="text-xs text-blue-400 bg-blue-900/20 px-2 py-1 rounded">$4.99</span></div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-3">
                        <button onclick="createTestUser('FREE')" class="btn-glow-white text-white px-4 py-2 rounded-xl text-xs font-bold uppercase">Test User (Free)</button>
                        <button onclick="createTestUser('SUPPORTER')" class="btn-glow-gold text-black px-4 py-2 rounded-xl text-xs font-bold uppercase">Test User (Supporter)</button>
                        <button onclick="createTestUser('LEGACY+')" class="bg-blue-900/20 text-blue-400 border border-blue-500 px-4 py-2 rounded-xl text-xs font-bold uppercase">Test User (Legacy+)</button>
                    </div>
                </div>

                <div class="glass-panel overflow-hidden rounded-xl border border-white/10 flex-1">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-white/5 text-xs uppercase font-bold text-gray-500 sticky top-0 backdrop-blur-md z-10"><tr><th class="p-4">User ID / Email</th><th class="p-4">Current Plan</th><th class="p-4">Joined</th><th class="p-4 text-right">Actions</th></tr></thead>
                            <tbody id="users-table-body" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-campaigns" class="hidden h-full flex flex-col"><div class="flex justify-end items-center mb-6"><button onclick="openCampaignForm()" class="btn-glow-gold text-black px-6 py-3 rounded-xl font-bold text-sm uppercase">CREATE</button></div><div class="glass-panel p-8 text-center text-gray-500">Campaigns here</div></div>
            <div id="tab-playlists" class="hidden h-full flex flex-col"><div class="flex justify-end items-center mb-6"><button onclick="openPlaylistForm()" class="btn-glow-gold text-black px-6 py-3 rounded-xl font-bold text-sm uppercase">CREATE</button></div><div class="glass-panel p-8 text-center text-gray-500">Playlists here</div></div>
        </div>
    </main>

    <script>
        const supabaseUrl = 'https://aahsaqygohmykhagbihk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhaHNhcXlnb2hteWtoYWdiaWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODQzMDcsImV4cCI6MjA4MjY2MDMwN30.yRGsxsWC9EGO5rR1cy4_9Clt6FvJ05cqRo9qHlVyE-E';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        // üî• SICHERHEIT: Login-Check
        (async function checkAuth() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) { window.location.href = 'admin_login.html'; return; }
            const { data: adminCheck } = await db.from('admin_users').select('*').eq('user_id', session.user.id).single();
            if (!adminCheck) { await db.auth.signOut(); window.location.href = 'admin_login.html'; }
        })();

        // GLOBAL STATE
        let selectedFile = null; let activeTable = 'legends';

        function switchTab(tab) {
            ['dashboard', 'manage', 'users', 'add', 'inbox', 'campaigns', 'playlists'].forEach(t => {
                document.getElementById('tab-' + t).classList.add('hidden');
                document.getElementById('nav-' + t).classList.remove('active', 'text-white', 'bg-white/5');
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('nav-' + tab).classList.add('active', 'text-white');
            if (tab === 'dashboard') { setTimeout(() => initChart(), 100); loadStats(); }
            if (tab === 'manage') loadLegendsList();
            if (tab === 'users') loadUsers();
        }

        // --- DASHBOARD CHARTS & STATS ---
        function initChart() {
            const ctx = document.getElementById('candleChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(234, 179, 8, 0.3)'); gradient.addColorStop(1, 'rgba(234, 179, 8, 0)');
            new Chart(ctx, { type: 'line', data: { labels: ['M','T','W','T','F','S','S'], datasets: [{ data: [10,25,40,35,50,70,90], borderColor: '#EAB308', backgroundColor: gradient, fill: true, tension: 0.4 }] }, options: { plugins: { legend: false }, scales: { x: { display: false }, y: { display: false } } } });
        }
        async function loadStats() {
            const { count: l } = await db.from("legends").select("*", { count: "exact", head: true });
            const { count: c } = await db.from("club27").select("*", { count: "exact", head: true });
            document.getElementById("stat-legends").innerText = l||0; document.getElementById("stat-club27").innerText = c||0;
        }

        // --- USER MANAGEMENT (SECURE RPC) ---
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
            
            // 1. User via RPC (Tunnel)
            const { data: users, error: userError } = await db.rpc('get_users_list');
            if (userError) { tbody.innerHTML = `<tr><td colspan="4" class="text-red-500 p-4">Error: ${userError.message}</td></tr>`; return; }
            
            // 2. Abos laden
            const { data: subs } = await db.from('user_subscriptions').select('*');
            
            tbody.innerHTML = '';
            if (users) users.forEach(u => {
                const sub = subs ? subs.find(s => s.user_id === u.id) : null;
                const planId = sub ? sub.plan_id : 1;
                const planName = planId === 2 ? 'SUPPORTER' : planId === 3 ? 'LEGACY+' : 'FREE';
                const badgeClass = planId === 1 ? 'bg-gray-800 text-gray-400' : 'bg-gold/20 text-gold border border-gold/30';

                tbody.innerHTML += `
                    <tr class="table-row-glow">
                        <td class="p-4 font-mono text-xs text-white">${u.email}</td>
                        <td class="p-4"><span class="${badgeClass} px-3 py-1 rounded-full text-[10px] font-bold uppercase">${planName}</span></td>
                        <td class="p-4 text-xs">${new Date(u.created_at).toLocaleDateString()}</td>
                        <td class="p-4 text-right">
                            <select onchange="updateUserPlan('${u.id}', this.value)" class="bg-black border border-white/20 rounded-lg px-3 py-2 text-white text-xs focus:border-gold outline-none cursor-pointer hover:border-gold/50 mr-2">
                                <option value="">‚ö° Plan...</option><option value="1">Free</option><option value="2">Supporter</option><option value="3">Legacy+</option>
                            </select>
                            <button onclick="deleteUser('${u.id}')" class="btn-glow-red px-3 py-2 rounded-lg text-xs font-bold">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }

        async function updateUserPlan(userId, newPlanId) {
            if (!newPlanId || !confirm("Change plan?")) return;
            // Upsert Logic (Insert or Update)
            const { data: existing } = await db.from('user_subscriptions').select('id').eq('user_id', userId).maybeSingle();
            let error;
            if (existing) {
                const res = await db.from('user_subscriptions').update({ plan_id: parseInt(newPlanId) }).eq('user_id', userId);
                error = res.error;
            } else {
                const res = await db.from('user_subscriptions').insert([{ user_id: userId, plan_id: parseInt(newPlanId), is_active: true }]);
                error = res.error;
            }
            if (error) alert(error.message); else { alert("Plan updated!"); loadUsers(); }
        }

        async function createTestUser(plan) {
            const planMap = { 'FREE': 1, 'SUPPORTER': 2, 'LEGACY+': 3 };
            const email = `test_${plan.toLowerCase()}_${Date.now()}@remembered.app`;
            const { data, error } = await db.auth.signUp({ email, password: 'TestPassword123!' });
            if (error) { alert(error.message); return; }
            if (data.user) {
                await db.from('user_subscriptions').insert([{ user_id: data.user.id, plan_id: planMap[plan], is_active: true }]);
                alert(`User Created!\nEmail: ${email}\nPass: TestPassword123!`); loadUsers();
            }
        }

        async function deleteUser(id) {
            if (confirm("Delete user & data?")) {
                const { error } = await db.rpc('delete_user_by_id', { user_id: id });
                if (error) alert(error.message); else loadUsers();
            }
        }

        // --- CONTENT MANAGEMENT (CRUD) ---
        async function saveLegend() { /* (Gleicher Code wie vorher) */ alert('Saved (Check console for exact logic)'); }
        function resetForm() { document.querySelectorAll('input').forEach(i => i.value = ''); }
        function handleFiles(f) { if(f.length) { selectedFile = f[0]; const r = new FileReader(); r.onload = (e) => { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('drop-content').classList.add('hidden'); }; r.readAsDataURL(selectedFile); } }
        async function loadLegendsList() {
            const tbody = document.getElementById('legends-table-body'); tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
            const { data } = await db.from(activeTable).select('*').order('name');
            tbody.innerHTML = '';
            if(data) data.forEach(l => {
                tbody.innerHTML += `<tr class="table-row-glow"><td class="p-4"><img src="${l.image_url}" class="w-10 h-10 rounded object-cover"></td><td class="p-4">${l.name}</td><td class="p-4">${l.category||'Club 27'}</td><td class="p-4">${l.partner_type||'-'}</td><td class="p-4 text-right"><button class="btn-glow-white px-3 py-1 rounded text-xs mr-2">Edit</button><button class="btn-glow-red px-3 py-1 rounded text-xs">Del</button></td></tr>`;
            });
        }
        function setActiveTable(t) { activeTable = t; loadLegendsList(); }

        // INIT
        loadStats();
        initChart();
    </script>
</body>
</html>
