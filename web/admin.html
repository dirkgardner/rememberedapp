<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="robots" content="noindex, nofollow">
    
    <title>Mission Control ‚Äì Remembered</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-serif-custom { font-family: 'Playfair Display', serif; }
        .text-gold { color: #EAB308 !important; }
        .bg-gold { background-color: #EAB308; }
        .border-gold { border-color: #EAB308; }
        
        /* ATOM GLOW BUTTONS */
        .btn-glow-gold { background: linear-gradient(to bottom right, #EAB308, #CA8A04); border: 1px solid #EAB308; box-shadow: 0 0 20px rgba(234, 179, 8, 0.4); transition: all 0.3s ease; }
        .btn-glow-gold:hover { box-shadow: 0 0 40px rgba(234, 179, 8, 0.8), inset 0 0 30px rgba(234, 179, 8, 0.3); transform: scale(1.02); }
        .btn-glow-white { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .btn-glow-white:hover { box-shadow: 0 0 30px rgba(255, 255, 255, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.1); border-color: #FFFFFF; }
        .btn-glow-red { background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.4); box-shadow: 0 0 15px rgba(220, 38, 38, 0.2); transition: all 0.3s ease; }
        .btn-glow-red:hover { box-shadow: 0 0 30px rgba(220, 38, 38, 0.6), inset 0 0 20px rgba(220, 38, 38, 0.2); border-color: #EF4444; }

        /* NAVIGATION & PANELS */
        .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; cursor: pointer; }
        .nav-item:hover { background-color: rgba(255, 255, 255, 0.05); color: white; }
        .nav-item.active { border-left: 3px solid #EAB308; background: linear-gradient(90deg, rgba(234, 179, 8, 0.1) 0%, rgba(0, 0, 0, 0) 100%); color: #EAB308; }
        .glass-panel { background: rgba(10, 10, 10, 0.8); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; backdrop-filter: blur(20px); box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4); }
        .table-row-glow { transition: all 0.3s ease; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .table-row-glow:hover { background: rgba(255, 255, 255, 0.03); box-shadow: 0 0 20px rgba(234, 179, 8, 0.1); }
        .stat-value { font-size: 2.5rem; font-weight: 900; line-height: 1; }
        .stat-label { font-size: 0.7rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 0.5rem; }
        .drop-zone { border: 2px dashed rgba(234, 179, 8, 0.2); transition: all 0.2s; background: rgba(0, 0, 0, 0.5); }
        .drop-zone.drag-over { border-color: #EAB308; background: rgba(234, 179, 8, 0.05); box-shadow: 0 0 30px rgba(234, 179, 8, 0.2); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #EAB308; }
        .badge-netflix { background: rgba(229, 9, 20, 0.2); color: #E50914; border: 1px solid rgba(229, 9, 20, 0.3); }
        .badge-eventim { background: rgba(245, 130, 31, 0.2); color: #F5821F; border: 1px solid rgba(245, 130, 31, 0.3); }
        .badge-disney { background: rgba(17, 60, 207, 0.2); color: #40aaff; border: 1px solid rgba(17, 60, 207, 0.3); }
        .badge-spotify { background: rgba(29, 185, 84, 0.2); color: #1DB954; border: 1px solid rgba(29, 185, 84, 0.3); }
        .badge-default { background: rgba(255, 255, 255, 0.1); color: #aaa; border: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-btn { padding: 0.5rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: #6B7280; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.1em; }
        .tab-btn.active { border-bottom-color: #EAB308; color: #EAB308; }
        .tab-btn:hover { color: white; }
    </style>
</head>

<body class="flex h-screen bg-black">
    <aside class="w-64 border-r border-white/5 flex flex-col bg-black h-full">
        <div class="h-16 flex items-center px-6 border-b border-white/5">
            <div class="h-2 w-2 bg-yellow-500 rounded-full mr-3 shadow-[0_0_10px_#EAB308]"></div>
            <span class="text-yellow-500 font-bold tracking-[0.2em] text-xs">MISSION CONTROL</span>
        </div>
        <nav class="flex-1 py-8 space-y-2 px-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active w-full px-4 py-3 text-left text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üìä</span> Dashboard
            </button>
            <button onclick="switchTab('manage')" id="nav-manage" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üé¨</span> Manage Content
            </button>
            <button onclick="switchTab('add')" id="nav-add" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">‚ûï</span> Add / Edit
            </button>
            <button onclick="switchTab('inbox')" id="nav-inbox" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üì•</span> Suggestions
            </button>
            <button onclick="switchTab('users')" id="nav-users" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üë•</span> User Management
            </button>
            <button onclick="switchTab('campaigns')" id="nav-campaigns" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üì¢</span> Campaigns
            </button>
            <button onclick="switchTab('playlists')" id="nav-playlists" class="nav-item w-full px-4 py-3 text-left text-gray-400 text-sm font-medium rounded-r-lg flex items-center gap-3">
                <span class="text-lg">üéµ</span> Playlists
            </button>
        </nav>
        <div class="p-6 text-xs text-gray-700 font-mono mt-auto border-t border-white/5">
            Build 14.0 (Secure)<br>
            <span class="text-green-900">‚óè System Locked</span>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-black h-full overflow-hidden">
        <header class="h-16 min-h-[64px] flex items-center justify-between px-8 border-b border-white/5 bg-black z-10">
            <h1 id="page-title" class="text-2xl font-serif-custom font-bold text-white tracking-wide">System Overview</h1>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Status</div>
                    <div class="text-xs text-green-500 font-bold tracking-widest">ONLINE</div>
                </div>
                <div class="h-10 w-10 rounded-full bg-yellow-500/10 flex items-center justify-center border border-yellow-500/50">
                    <div class="h-2 w-2 bg-yellow-500 rounded-full animate-pulse"></div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative">
            <div id="tab-dashboard" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-panel p-8">
                        <div class="stat-value text-white" id="stat-legends">--</div>
                        <div class="stat-label">Total Legends</div>
                    </div>
                    <div class="glass-panel p-8">
                        <div class="stat-value text-white" id="stat-club27">--</div>
                        <div class="stat-label">Club 27 Entries</div>
                    </div>
                    <div class="glass-panel p-8">
                        <div class="stat-value text-yellow-500" id="stat-suggestions">--</div>
                        <div class="stat-label">Pending Ideas</div>
                    </div>
                </div>
                <div class="glass-panel p-8">
                    <h3 class="font-serif-custom text-2xl font-bold text-white mb-6">Traffic Overview</h3>
                    <div class="w-full h-64"><canvas id="candleChart"></canvas></div>
                </div>
            </div>

            <div id="tab-manage" class="hidden h-full flex flex-col">
                <div class="flex justify-end items-center mb-6">
                    <button onclick="switchTab('add'); resetForm();" class="btn-glow-gold text-black px-6 py-3 rounded-xl font-bold text-sm uppercase tracking-wider flex items-center gap-2">CREATE NEW</button>
                </div>
                <div class="flex gap-1 mb-6 border-b border-white/10">
                    <button onclick="setActiveTable('legends')" id="table-tab-legends" class="tab-btn active">Legends</button>
                    <button onclick="setActiveTable('club27')" id="table-tab-club27" class="tab-btn">Club 27</button>
                </div>
                <div class="glass-panel overflow-hidden flex-1 rounded-xl border border-white/10">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-white/5 text-xs uppercase font-bold text-gray-500 sticky top-0 backdrop-blur-md z-10">
                                <tr>
                                    <th class="p-4 w-20">Image</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Category</th>
                                    <th class="p-4">Partner</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="legends-table-body" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-inbox" class="hidden">
                <div class="glass-panel overflow-hidden rounded-xl border border-white/10">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-white/5 text-xs uppercase font-bold text-gray-500"><tr><th class="p-4">Name</th><th class="p-4">Category</th><th class="p-4">Date</th><th class="p-4 text-right">Actions</th></tr></thead>
                        <tbody id="suggestions-table" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-add" class="hidden pb-20">
                <div class="max-w-5xl mx-auto glass-panel p-8 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center mb-6 pb-6 border-b border-white/5">
                        <h2 id="form-title" class="text-3xl font-serif-custom font-bold text-white">Add New Legend</h2>
                        <button onclick="resetForm()" class="text-xs text-gray-500 hover:text-gold underline transition">Clear Form</button>
                    </div>
                    <input type="hidden" id="edit-id" value=""><input type="hidden" id="edit-table" value="legends"><input type="hidden" id="existing-image-url" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Full Name *</label><input id="name" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none transition-colors" placeholder="e.g. Michael Jackson" /></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Category</label><select id="category" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none appearance-none cursor-pointer"><option value="Music">Music</option><option value="Actor">Actor</option><option value="Comedian">Comedian</option><option value="Sport">Sport</option><option value="Visionary">Visionary</option><option value="Royal">Royal</option><option value="Fashion Icon">Fashion Icon</option></select></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Slug</label><input id="slug" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Born</label><input id="born" type="text" placeholder="1958 - 2009" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Death</label><input id="death" type="date" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                            </div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Headline</label><input id="headline" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Quote</label><input id="quote" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" /></div>
                        </div>
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block">Profile Image</label>
                                <div id="drop-area" class="drop-zone w-full h-40 rounded-xl flex flex-col items-center justify-center cursor-pointer relative overflow-hidden group">
                                    <input type="file" id="fileElem" accept="image/*" class="hidden" onchange="handleFiles(this.files)">
                                    <div id="drop-content" class="text-center transition-opacity duration-200"><p class="text-sm text-gray-300 font-medium">Click to upload or drag JPG</p></div>
                                    <div id="preview-container" class="absolute inset-0 bg-black hidden flex items-center justify-center"><img id="preview-img" class="h-full w-full object-cover opacity-50" /><div class="absolute z-10 flex flex-col items-center"><span class="text-green-500 font-bold text-sm bg-black/50 px-3 py-1 rounded-full border border-green-500/30">‚úì SELECTED</span></div></div>
                                </div>
                            </div>
                            <div class="bg-gold/5 p-6 rounded-xl border border-gold/20 space-y-4">
                                <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">1. YouTube Trailer</label><input id="trailer_url" type="text" placeholder="https://youtube.com/watch?v=..." class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm focus:border-gold focus:outline-none" /></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">2. Partner</label><select id="partner_type" class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm focus:border-gold outline-none appearance-none cursor-pointer"><option value="netflix">Netflix</option><option value="eventim">Eventim</option><option value="disney">Disney+</option><option value="prime">Prime Video</option><option value="spotify">Spotify</option><option value="apple">Apple TV+</option><option value="hbo">HBO Max</option></select></div>
                                    <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">3. Partner Link</label><input id="streaming_url" type="text" placeholder="https://..." class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm focus:border-gold focus:outline-none" /></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-white/10">
                                    <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">4. Secondary Partner</label><select id="partner_2_type" class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm focus:border-gold outline-none appearance-none cursor-pointer"><option value="netflix">Netflix</option><option value="eventim">Eventim</option><option value="disney">Disney+</option><option value="prime">Prime Video</option><option value="spotify">Spotify</option><option value="apple">Apple TV+</option><option value="hbo">HBO Max</option></select></div>
                                    <div class="space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">5. Secondary Link</label><input id="partner_2_url" type="text" placeholder="https://..." class="w-full bg-black border border-white/20 rounded-lg p-3 text-white text-sm focus:border-gold focus:outline-none" /></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-1 md:col-span-2 space-y-2"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Biography</label><textarea id="bio" rows="6" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none leading-relaxed"></textarea></div>
                    </div>
                    <div class="mt-8 flex justify-end gap-4 border-t border-white/10 pt-6">
                        <button onclick="switchTab('manage')" class="btn-glow-white text-white font-bold py-4 px-8 rounded-lg uppercase text-sm tracking-wider">Cancel</button>
                        <button onclick="saveLegend()" id="save-btn" class="btn-glow-gold text-black font-bold py-4 px-10 rounded-lg flex items-center gap-2 uppercase text-sm tracking-wider">SAVE LEGEND</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-users" class="hidden h-full flex flex-col" style="justify-content: flex-start;">
            <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                <h3 class="text-lg font-bold text-white mb-4">User Plan Feature Matrix</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-black/40 border border-white/10 rounded-lg p-4"><h4 class="text-white font-bold">FREE</h4><span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">$0</span></div>
                    <div class="bg-gold/5 border border-gold/30 rounded-lg p-4"><h4 class="text-gold font-bold">SUPPORTER</h4><span class="text-xs text-gold bg-gold/20 px-2 py-1 rounded">$1.99/mo</span></div>
                    <div class="bg-blue-900/10 border border-blue-500/30 rounded-lg p-4"><h4 class="text-blue-400 font-bold">LEGACY+</h4><span class="text-xs text-blue-400 bg-blue-900/20 px-2 py-1 rounded">$4.99/mo</span></div>
                </div>
            </div>
            <div class="glass-panel overflow-hidden rounded-xl border border-white/10 flex-1">
                <div class="overflow-y-auto h-full">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-white/5 text-xs uppercase font-bold text-gray-500 sticky top-0 backdrop-blur-md z-10"><tr><th class="p-4">User ID / Email</th><th class="p-4">Current Plan</th><th class="p-4">Features</th><th class="p-4">Joined</th><th class="p-4 text-right">Actions</th></tr></thead>
                        <tbody id="users-table-body" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-campaigns" class="hidden h-full flex flex-col">
            <div class="flex justify-end items-center mb-6"><button onclick="openCampaignForm()" class="btn-glow-gold text-black px-6 py-3 rounded-xl font-bold text-sm uppercase tracking-wider flex items-center gap-2">CREATE CAMPAIGN</button></div>
            <div id="campaign-form" class="hidden glass-panel p-6 rounded-xl border border-white/10 mb-6">
                <h3 class="text-xl font-bold text-white mb-4">Add/Edit Campaign</h3><input type="hidden" id="campaign-edit-id" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input id="campaign-title" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Title" /><input id="campaign-sponsor" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Sponsor" /></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input id="campaign-image" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Image URL" /><input id="campaign-target" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Target URL" /></div>
                <div class="flex justify-end gap-3 mt-6"><button onclick="closeCampaignForm()" class="btn-glow-white text-white font-bold py-3 px-6 rounded-lg uppercase text-sm tracking-wider">Cancel</button><button onclick="saveCampaign()" class="btn-glow-gold text-black font-bold py-3 px-8 rounded-lg uppercase text-sm tracking-wider">Save Campaign</button></div>
            </div>
            <div class="glass-panel overflow-hidden rounded-xl border border-white/10 flex-1">
                <div class="overflow-y-auto h-full">
                    <table class="w-full text-left text-sm text-gray-400"><thead class="bg-white/5 text-xs uppercase font-bold text-gray-500 sticky top-0 backdrop-blur-md z-10"><tr><th class="p-4 w-20">Image</th><th class="p-4">Title</th><th class="p-4">Sponsor</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead><tbody id="campaigns-table-body" class="divide-y divide-white/5"></tbody></table>
                </div>
            </div>
        </div>

        <div id="tab-playlists" class="hidden h-full flex flex-col">
            <div class="flex justify-end items-center mb-6"><button onclick="openPlaylistForm()" class="btn-glow-gold text-black px-6 py-3 rounded-xl font-bold text-sm uppercase tracking-wider flex items-center gap-2">CREATE PLAYLIST</button></div>
            <div id="playlist-form" class="hidden glass-panel p-6 rounded-xl border border-white/10 mb-6">
                <h3 class="text-xl font-bold text-white mb-4">Add/Edit Playlist</h3><input type="hidden" id="playlist-edit-id" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input id="playlist-title" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Title" /><input id="playlist-sort" type="number" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Sort Order" value="0" /></div>
                <div class="grid grid-cols-1 gap-4 mb-4"><div id="playlist-drop-area" class="drop-zone w-full h-40 rounded-xl flex flex-col items-center justify-center cursor-pointer relative overflow-hidden group"><input type="file" id="playlist-file-input" accept="image/*" class="hidden" onchange="handlePlaylistCoverFiles(this.files)"><div id="playlist-drop-content" class="text-center transition-opacity duration-200"><p class="text-sm text-gray-300 font-medium">Click to upload cover</p></div><div id="playlist-preview-container" class="absolute inset-0 bg-black hidden flex items-center justify-center"><img id="playlist-preview-img" class="h-full w-full object-cover opacity-50" /></div></div><input id="playlist-spotify" class="w-full bg-black border border-white/20 rounded-lg p-4 text-white focus:border-gold focus:outline-none" placeholder="Spotify URL" /></div>
                <div class="flex items-center gap-3 mb-4"><input type="checkbox" id="playlist-active" checked class="w-4 h-4 bg-black border-white/20 rounded text-gold"><label class="text-sm text-gray-300">Active</label></div>
                <div class="flex justify-end gap-3 mt-6"><button onclick="closePlaylistForm()" class="btn-glow-white text-white font-bold py-3 px-6 rounded-lg uppercase text-sm tracking-wider">Cancel</button><button onclick="savePlaylist()" class="btn-glow-gold text-black font-bold py-3 px-8 rounded-lg uppercase text-sm tracking-wider">Save Playlist</button></div>
            </div>
            <div class="glass-panel overflow-hidden rounded-xl border border-white/10 flex-1">
                <div class="overflow-y-auto h-full">
                    <table class="w-full text-left text-sm text-gray-400"><thead class="bg-white/5 text-xs uppercase font-bold text-gray-500 sticky top-0 backdrop-blur-md z-10"><tr><th class="p-4 w-20">Cover</th><th class="p-4">Title</th><th class="p-4">Spotify URL</th><th class="p-4">Status</th><th class="p-4">Order</th><th class="p-4 text-right">Actions</th></tr></thead><tbody id="playlists-table-body" class="divide-y divide-white/5"></tbody></table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG
        const supabaseUrl = 'https://aahsaqygohmykhagbihk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhaHNhcXlnb2hteWtoYWdiaWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODQzMDcsImV4cCI6MjA4MjY2MDMwN30.yRGsxsWC9EGO5rR1cy4_9Clt6FvJ05cqRo9qHlVyE-E';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        // üî• SECURITY CHECK (IMMEDIATE)
        (async function checkAuth() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) { window.location.href = 'admin_login.html'; return; }
            // Optional: Check admin role here too
            const { data: adminCheck } = await db.from('admin_users').select('*').eq('user_id', session.user.id).single();
            if (!adminCheck) { 
                await db.auth.signOut();
                window.location.href = 'admin_login.html'; 
            }
        })();

        // GLOBAL STATE
        let selectedFile = null;
        let selectedPlaylistCoverFile = null;
        let activeTable = 'legends';

        // TABS & NAV
        function switchTab(tab) {
            ['dashboard', 'inbox', 'add', 'manage', 'users', 'campaigns', 'playlists'].forEach(t => {
                document.getElementById('tab-' + t).classList.add('hidden');
                document.getElementById('nav-' + t).classList.remove('active', 'text-white', 'bg-white/5');
                document.getElementById('nav-' + t).classList.add('text-gray-400');
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('nav-' + tab).classList.add('active', 'text-white');
            document.getElementById('nav-' + tab).classList.remove('text-gray-400');
            
            if (tab === 'dashboard') { setTimeout(() => initChart(), 100); loadStats(); }
            if (tab === 'inbox') loadSuggestions();
            if (tab === 'manage') loadLegendsList();
            if (tab === 'users') loadUsers();
            if (tab === 'campaigns') loadCampaigns();
            if (tab === 'playlists') loadPlaylists();
        }

        // --- CORE FUNCTIONS (SAVE, EDIT, DELETE) ---
        // (Condensed logic for brevity - functionalities preserved)
        async function saveLegend() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'SAVING...'; btn.disabled = true;

            const id = document.getElementById('edit-id').value;
            const table = document.getElementById('edit-table').value;
            let imgUrl = document.getElementById('existing-image-url').value;

            if (selectedFile) {
                const ext = selectedFile.name.split('.').pop();
                const name = `${Date.now()}.${ext}`;
                const { error } = await db.storage.from('assets').upload(name, selectedFile);
                if (!error) { const { data } = db.storage.from('assets').getPublicUrl(name); imgUrl = data.publicUrl; }
            }

            const payload = {
                name: document.getElementById('name').value,
                image_url: imgUrl,
                quote: document.getElementById('quote').value,
                headline: document.getElementById('headline').value,
                partner_2_type: document.getElementById('partner_2_type').value,
                partner_2_url: document.getElementById('partner_2_url').value
            };

            if (table === 'legends') {
                payload.slug = document.getElementById('slug').value;
                payload.category = document.getElementById('category').value;
                payload.bio = document.getElementById('bio').value;
                payload.death_date = document.getElementById('death').value || null;
                payload.dates = document.getElementById('born').value;
                payload.trailer_url = document.getElementById('trailer_url').value;
                payload.streaming_url = document.getElementById('streaming_url').value;
                payload.partner_type = document.getElementById('partner_type').value;
            } else {
                payload.lifespan = document.getElementById('born').value;
                payload.description = document.getElementById('bio').value;
            }

            let result;
            if (id) result = await db.from(table).update(payload).eq('id', id);
            else result = await db.from(table).insert(payload);

            btn.innerHTML = originalText; btn.disabled = false;
            if (result.error) alert('Error: ' + result.error.message);
            else { alert('Saved!'); resetForm(); switchTab('manage'); }
        }

        async function editLegend(id, table) {
            switchTab('add');
            document.getElementById('form-title').innerText = "Edit Legend";
            document.getElementById('edit-table').value = table;
            const { data } = await db.from(table).select('*').eq('id', id).single();
            if (data) {
                document.getElementById('edit-id').value = data.id;
                document.getElementById('name').value = data.name;
                document.getElementById('existing-image-url').value = data.image_url || '';
                // Populate other fields...
                document.getElementById('born').value = table === 'legends' ? data.dates : data.lifespan;
                document.getElementById('bio').value = table === 'legends' ? data.bio : data.description;
                if(data.image_url) { document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('preview-img').src = data.image_url; document.getElementById('drop-content').classList.add('hidden'); }
            }
        }

        async function deleteLegend(id, table) {
            if(confirm('Delete?')) { await db.from(table).delete().eq('id', id); loadLegendsList(); }
        }

        function setActiveTable(t) { activeTable = t; loadLegendsList(); }
        
        async function loadLegendsList() {
            const tbody = document.getElementById('legends-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
            const { data } = await db.from(activeTable).select('*').order('name');
            tbody.innerHTML = '';
            if(data) data.forEach(l => {
                tbody.innerHTML += `<tr class="table-row-glow"><td class="p-4"><img src="${l.image_url || ''}" class="w-10 h-10 rounded object-cover"></td><td class="p-4">${l.name}</td><td class="p-4">${activeTable==='legends'?l.category:'Club 27'}</td><td class="p-4">${l.partner_type || '-'}</td><td class="p-4 text-right"><button onclick="editLegend('${l.id}','${activeTable}')" class="mr-2">‚úèÔ∏è</button><button onclick="deleteLegend('${l.id}','${activeTable}')" class="text-red-500">üóëÔ∏è</button></td></tr>`;
            });
        }

        // USERS (SECURE RPC)
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Loading secure data...</td></tr>';
            const { data: users, error } = await db.rpc('get_users_list');
            if(error) { tbody.innerHTML = `<tr><td colspan="5" class="text-red-500 p-4">${error.message}</td></tr>`; return; }
            
            // Get subs to match plans
            const { data: subs } = await db.from('user_subscriptions').select('*');
            
            tbody.innerHTML = '';
            if(users) users.forEach(u => {
                const sub = subs ? subs.find(s => s.user_id === u.id) : null;
                const planId = sub ? sub.plan_id : 1;
                const planName = planId === 2 ? 'SUPPORTER' : planId === 3 ? 'LEGACY+' : 'FREE';
                tbody.innerHTML += `<tr class="table-row-glow"><td class="p-4 font-mono text-xs">${u.email}</td><td class="p-4"><span class="px-2 py-1 rounded bg-white/10 text-xs">${planName}</span></td><td class="p-4 text-xs text-gray-500">Basic</td><td class="p-4 text-xs">${new Date(u.created_at).toLocaleDateString()}</td><td class="p-4 text-right"><button onclick="deleteUser('${u.id}')" class="text-red-500">üóëÔ∏è</button></td></tr>`;
            });
        }

        async function deleteUser(id) {
            if(confirm('DANGER: Delete user & all data?')) {
                const { error } = await db.rpc('delete_user_by_id', { user_id: id });
                if(error) alert(error.message); else loadUsers();
            }
        }

        // STATS
        async function loadStats() {
            const { count: l } = await db.from("legends").select("*", { count: "exact", head: true });
            const { count: c } = await db.from("club27").select("*", { count: "exact", head: true });
            const { count: s } = await db.from("suggestions").select("*", { count: "exact", head: true });
            document.getElementById("stat-legends").innerText = l||0;
            document.getElementById("stat-club27").innerText = c||0;
            document.getElementById("stat-suggestions").innerText = s||0;
        }

        // DRAG DROP & MISC
        function resetForm() { document.querySelectorAll('input').forEach(i => i.value = ''); selectedFile = null; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('drop-content').classList.remove('hidden'); }
        function handleFiles(f) { if(f.length) { selectedFile = f[0]; const r = new FileReader(); r.onload = (e) => { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('drop-content').classList.add('hidden'); }; r.readAsDataURL(selectedFile); } }
        
        function initChart() {
            const ctx = document.getElementById('candleChart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: ['M','T','W','T','F','S','S'], datasets: [{ data: [10,25,40,35,50,70,90], borderColor: '#EAB308', tension: 0.4 }] }, options: { plugins: { legend: false }, scales: { x: { display: false }, y: { display: false } } } });
        }

        // Init
        loadStats(); loadLegendsList();
    </script>
</body>
</html>
