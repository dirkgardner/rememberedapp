<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    
    <meta name="robots" content="noindex, nofollow">
    
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>Remembered - Legends App</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        /* --- SAFE AREA SUPPORT (iPhone Notch) --- */
        :root {
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* --- BASE DESIGN --- */
        body {
            background-color: #050505;
            color: white;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif-custom {
            font-family: 'Playfair Display', serif;
        }

        /* --- COLORS (LUXURY UPGRADE) --- */
        .text-gold {
            color: #D4AF37 !important;
        }

        .bg-gold {
            background-color: #D4AF37;
        }

        .border-gold {
            border-color: #D4AF37;
        }

        /* Platinum accent for ultra-premium feel */
        .text-platinum {
            color: #E5E4E2 !important;
        }

        .bg-platinum {
            background-color: #E5E4E2;
        }

        /* --- UTILS --- */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Global scrollbar hiding - Instagram style */
        * {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        *::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari/WebKit */
        }

        body {
            overflow-x: hidden;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- MONETIZATION VIEW SCROLLBAR (DARK THEME) --- */
        #monetization-view::-webkit-scrollbar {
            width: 8px;
        }

        #monetization-view::-webkit-scrollbar-track {
            background: #000;
        }

        #monetization-view::-webkit-scrollbar-thumb {
            background: #1a1a1a;
            border-radius: 4px;
        }

        #monetization-view::-webkit-scrollbar-thumb:hover {
            background: #2a2a2a;
        }

        /* Firefox scrollbar styling for monetization view */
        #monetization-view {
            scrollbar-width: thin;
            scrollbar-color: #1a1a1a #000;
        }

        /* --- HEADER & NAVIGATION --- */
        .glass-header {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .journey-ring-container {
            display: flex;
            gap: 12px;
            padding: 0;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            align-items: center;
        }

        .journey-ring-item {
            flex-shrink: 0;
            scroll-snap-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            cursor: pointer;
            position: relative;
        }

        .journey-ring-circle {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: transparent;
            border: 1.5px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            font-size: 18px;
        }

        .journey-ring-item:hover .journey-ring-circle {
            transform: scale(1.03);
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 0 14px rgba(212, 175, 55, 0.15);
        }

        .journey-ring-item.active .journey-ring-circle {
            border-color: rgba(212, 175, 55, 0.8);
            background: rgba(212, 175, 55, 0.05);
        }

        .journey-ring-label {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(6px);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: rgba(212, 175, 55, 0);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            white-space: nowrap;
            pointer-events: none;
        }

        .journey-ring-item:hover .journey-ring-label {
            color: rgba(212, 175, 55, 0.9);
            transform: translateX(-50%) translateY(0);
        }

        /* --- CARDS (ATOM GLOW UPGRADE) --- */
        .legend-card {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: #000;
            transition: all 0.4s ease;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            animation: legendPulse 3s ease-in-out infinite;
        }

        .legend-card:hover {
            border-color: #FFFFFF;
            box-shadow: 0 0 40px rgba(255, 255, 255, 1), inset 0 0 30px rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            z-index: 10;
            animation: none;
        }

        .club27-card {
            border: 1px solid rgba(220, 38, 38, 0.4);
            background-color: #000;
            transition: all 0.4s ease;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
            animation: club27Pulse 3s ease-in-out infinite;
        }

        .club27-card:hover {
            border-color: #EF4444;
            box-shadow: 0 0 40px rgba(220, 38, 38, 1), inset 0 0 30px rgba(220, 38, 38, 0.4);
            transform: scale(1.02);
            z-index: 10;
            animation: none;
        }

        /* Pulsing animations for "living" effect */
        @keyframes legendPulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
            }
        }

        @keyframes club27Pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(220, 38, 38, 0.4);
            }
        }

        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* --- TRIBUTE SYSTEM (LUXURY UPGRADE) --- */
        .tribute-container {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
        }

        .candle-container,
        .flower-container {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .candle-active {
            border-color: #D4AF37;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6), inset 0 0 20px rgba(212, 175, 55, 0.2);
            background: rgba(212, 175, 55, 0.1);
        }

        .flower-active {
            border-color: #E5E4E2;
            box-shadow: 0 0 40px rgba(229, 228, 226, 0.6), inset 0 0 20px rgba(229, 228, 226, 0.2);
            background: rgba(229, 228, 226, 0.1);
        }

        .flame-icon,
        .flower-icon {
            color: #4B5563;
            transition: all 0.5s ease;
        }

        .candle-active .flame-icon {
            color: #D4AF37;
            filter: drop-shadow(0 0 10px #D4AF37);
            animation: flicker 1.5s infinite alternate;
        }

        .flower-active .flower-icon {
            color: #E5E4E2;
            filter: drop-shadow(0 0 10px #E5E4E2);
            animation: bloom 2s ease-in-out infinite alternate;
        }

        @keyframes flicker {
            0% {
                opacity: 0.8;
                transform: scale(1);
            }

            100% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        @keyframes bloom {
            0% {
                opacity: 0.9;
                transform: scale(1) rotate(0deg);
            }

            100% {
                opacity: 1;
                transform: scale(1.05) rotate(5deg);
            }
        }

        /* --- VIDEO LOCK & OVERLAY --- */
        .gate-blur {
            filter: blur(0px) brightness(0.6);
            transition: all 0.5s ease;
        }

        .gate-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gate-overlay:hover .gate-icon {
            transform: scale(1.1);
        }

        .gate-badge {
            background: #EAB308;
            color: black;
            font-weight: 900;
            font-size: 10px;
            padding: 6px 12px;
            border-radius: 99px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.4);
        }

        /* --- PARTNER BUTTONS (GRAPHIC & GLOW) --- */
        .partner-btn-base {
            background: linear-gradient(to bottom right, #151515, #000);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .partner-btn-base:hover {
            transform: scale(1.02);
        }

        /* Color Glows for Partners */
        .glow-netflix {
            border-color: #E50914;
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.3);
        }

        .glow-eventim {
            border-color: #F5821F;
            box-shadow: 0 0 20px rgba(245, 130, 31, 0.3);
        }

        .glow-disney {
            border-color: #113CCF;
            box-shadow: 0 0 20px rgba(17, 60, 207, 0.3);
        }

        .glow-prime {
            border-color: #00A8E1;
            box-shadow: 0 0 20px rgba(0, 168, 225, 0.3);
        }

        .glow-spotify {
            border-color: #1DB954;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
        }

        .glow-apple {
            border-color: #A3AAAE;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .glow-hbo {
            border-color: #9932CC;
            box-shadow: 0 0 20px rgba(153, 50, 204, 0.3);
        }

        /* --- NOBLE AD BANNER (CINEMATIC SPONSORED CONTENT) --- */
        .noble-ad-banner {
            position: relative;
            width: 100%;
            height: 200px;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 1px solid rgba(234, 179, 8, 0.2);
            background: #000;
        }

        .noble-ad-banner:hover {
            border-color: rgba(234, 179, 8, 0.5);
            box-shadow: 0 0 40px rgba(234, 179, 8, 0.2);
            transform: translateY(-2px);
        }

        .noble-ad-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transition: transform 0.6s ease;
        }

        .noble-ad-banner:hover .noble-ad-bg {
            transform: scale(1.05);
        }

        .noble-ad-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.6) 50%, rgba(0, 0, 0, 0.3) 100%);
        }

        .noble-ad-content {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2rem;
        }

        .noble-ad-label {
            display: inline-block;
            background: rgba(234, 179, 8, 0.15);
            border: 1px solid rgba(234, 179, 8, 0.4);
            color: #EAB308;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            padding: 4px 10px;
            border-radius: 4px;
            margin-bottom: 12px;
            width: fit-content;
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.1);
        }

        .noble-ad-title {
            font-size: 1.5rem;
            font-weight: 900;
            color: white;
            line-height: 1.2;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Spotify Embed Styling */
        .spotify-embed-container {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid rgba(29, 185, 84, 0.3);
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.2);
        }

        /* --- OFFICIAL PLAYLISTS SECTION --- */
        .playlist-scroll-container {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            gap: 1rem;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .playlist-scroll-container::-webkit-scrollbar {
            display: none;
        }

        .playlist-card {
            flex-shrink: 0;
            scroll-snap-align: start;
            width: 140px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .playlist-card:hover {
            transform: translateY(-4px) scale(1.02);
        }

        .playlist-cover {
            width: 140px;
            height: 140px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .playlist-card:hover .playlist-cover {
            border-color: rgba(234, 179, 8, 0.4);
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.3), 0 4px 16px rgba(0, 0, 0, 0.5);
        }

        .playlist-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0);
            transition: background 0.3s ease;
        }

        .playlist-card:hover .playlist-play-overlay {
            background: rgba(0, 0, 0, 0.3);
        }

        .playlist-play-icon {
            width: 40px;
            height: 40px;
            background: rgba(234, 179, 8, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.6);
        }

        .playlist-card:hover .playlist-play-icon {
            opacity: 1;
            transform: scale(1);
        }

        .playlist-title {
            margin-top: 8px;
            font-size: 12px;
            color: white;
            font-weight: 600;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.3;
        }

        /* --- MOBILE SUBSCRIPTION CARDS (RESPONSIVE) --- */
        /* Hide mobile cards by default (show on mobile via media query) */
        .mobile-plan-cards {
            display: none;
        }

        /* Mobile Plan Card Styling */
        .mobile-plan-card {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .mobile-plan-card-popular {
            border-color: rgba(234, 179, 8, 0.3);
            background: rgba(234, 179, 8, 0.03);
        }

        .mobile-plan-summary {
            padding: 20px;
            cursor: pointer;
            list-style: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-plan-summary::-webkit-details-marker {
            display: none;
        }

        .mobile-plan-content {
            padding: 0 20px 20px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Rotate the expand icon when details is open */
        details[open] .expand-icon {
            transform: rotate(180deg);
        }

        /* Media Queries: Mobile vs Desktop */
        @media (max-width: 768px) {

            /* MOBILE: Hide desktop table, show mobile cards */
            .overflow-x-auto {
                display: none !important;
            }

            .mobile-plan-cards {
                display: block !important;
            }

            .desktop-only-text {
                display: none !important;
            }
        }

        @media (min-width: 769px) {

            /* DESKTOP: Show table, hide mobile cards */
            .mobile-plan-cards {
                display: none !important;
            }

            .desktop-only-text {
                display: block !important;
            }
        }

        /* --- APPLE 2026: PROFILE DROPDOWN MENU --- */
        .profile-dropdown {
            position: fixed;
            top: calc(4rem + env(safe-area-inset-top));
            right: 1rem;
            min-width: 280px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        .profile-dropdown.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .profile-menu-section {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .profile-menu-section:last-child {
            border-bottom: none;
        }

        .profile-menu-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6B7280;
            font-weight: 700;
            padding: 8px 12px 4px 12px;
            margin-bottom: 2px;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .profile-menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .profile-menu-item:active {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(0.98);
        }

        .profile-menu-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            color: #9CA3AF;
            transition: color 0.2s ease;
        }

        .profile-menu-item:hover .profile-menu-icon {
            color: #EAB308;
        }

        .profile-menu-item-gold .profile-menu-icon {
            color: #EAB308;
        }

        .profile-menu-item-red .profile-menu-icon {
            color: #EF4444;
        }

        /* Dropdown backdrop */
        .profile-dropdown-backdrop {
            position: fixed;
            inset: 0;
            background: transparent;
            z-index: 45;
            display: none;
        }

        .profile-dropdown-backdrop.active {
            display: block;
        }

        /* --- APPLE 2026: CONTEXT MENU FOR CARDS --- */
        .context-menu {
            position: fixed;
            min-width: 220px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            overflow: hidden;
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .context-menu.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .context-menu-section {
            padding: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .context-menu-section:last-child {
            border-bottom: none;
        }

        .context-menu-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6B7280;
            font-weight: 700;
            padding: 6px 10px 4px 10px;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: white;
            font-size: 13px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-menu-item:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.98);
        }

        .context-menu-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: #9CA3AF;
        }

        .context-menu-item:hover .context-menu-icon {
            color: #EAB308;
        }

        .context-menu-item-gold .context-menu-icon {
            color: #EAB308;
        }

        .context-menu-item-red .context-menu-icon {
            color: #EF4444;
        }

        /* Context menu backdrop */
        .context-menu-backdrop {
            position: fixed;
            inset: 0;
            background: transparent;
            z-index: 95;
            display: none;
        }

        .context-menu-backdrop.active {
            display: block;
        }

        /* ============================================================================
            ETERNAL COORDINATES - 3D FLYOVER (ANTIGRAVITY LUXURY)
            ============================================================================ */

        /* Full-screen Flyover Modal */
        .flyover-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.98), rgba(10, 10, 20, 0.95));
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .flyover-modal.active {
            opacity: 1;
        }

        #eternal-flyover-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #eternal-map {
            width: 100%;
            height: 100%;
        }

        /* Glassmorphic Overlay */
        .flyover-overlay {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;

            background: rgba(17, 24, 39, 0.90);
            backdrop-filter: blur(60px) saturate(200%);
            -webkit-backdrop-filter: blur(60px) saturate(200%);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 28px;
            padding: 36px;

            box-shadow:
                0 0 80px rgba(212, 175, 55, 0.25),
                inset 0 0 50px rgba(212, 175, 55, 0.08);
        }

        .flyover-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .flyover-icon {
            font-size: 32px;
            filter: drop-shadow(0 0 20px rgba(234, 179, 8, 0.6));
        }

        .flyover-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 400;
            letter-spacing: 0.1em;
            color: #D4AF37;
            margin: 0;
            text-transform: uppercase;
        }

        .flyover-name {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin: 0 0 16px 0;
            text-align: center;
            letter-spacing: 0.02em;
        }

        .flyover-location {
            font-size: 16px;
            font-weight: 500;
            color: #D4AF37;
            margin: 0;
            text-align: center;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .flyover-city {
            font-size: 13px;
            color: rgba(229, 228, 226, 0.7);
            margin: 8px 0 0 0;
            text-align: center;
            letter-spacing: 0.1em;
        }

        .flyover-description {
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
            text-align: center;
            margin: 28px 0;
            font-weight: 300;
        }

        .flyover-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .flyover-action {
            background: rgba(212, 175, 55, 0.12);
            border: 1px solid rgba(212, 175, 55, 0.35);
            border-radius: 14px;
            padding: 14px 28px;
            color: #D4AF37;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flyover-action:hover {
            background: rgba(212, 175, 55, 0.25);
            border-color: rgba(212, 175, 55, 0.5);
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        /* Close Button */
        .flyover-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flyover-close:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.5);
            transform: scale(1.1);
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .flyover-overlay {
                bottom: 20px;
                width: 95%;
                padding: 24px;
            }

            .flyover-name {
                font-size: 24px;
            }

            .flyover-title {
                font-size: 20px;
            }

            .flyover-description {
                font-size: 14px;
            }
        }
    </style>
</head>

<body class="min-h-screen pb-24 selection:bg-gold selection:text-black">

    <header
        class="fixed top-0 w-full z-40 glass-header h-16 flex items-center justify-between px-4 md:px-8 transition-all duration-300"
        style="padding-top: max(1rem, env(safe-area-inset-top)); height: calc(4rem + env(safe-area-inset-top));"
        id="main-header">
        <nav class="flex-1 overflow-x-auto no-scrollbar">
            <div class="journey-ring-container">
                <div class="journey-ring-item active" onclick="journeyRingNavigate(this, 'showHome()')">
                    <div class="journey-ring-circle">‚≠ê</div>
                    <span class="journey-ring-label">All</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'filterCategory(\'Music\')')">
                    <div class="journey-ring-circle">üéµ</div>
                    <span class="journey-ring-label">Music</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'filterCategoryMulti([\'Actor\', \'Comedian\'])')">
                    <div class="journey-ring-circle">üé≠</div>
                    <span class="journey-ring-label">Film & Comedy</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'filterCategory(\'Sport\')')">
                    <div class="journey-ring-circle">üèü</div>
                    <span class="journey-ring-label">Sport</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'filterCategory(\'Visionary\')')">
                    <div class="journey-ring-circle">üß†</div>
                    <span class="journey-ring-label">Visionary</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'filterCategory(\'Royal\')')">
                    <div class="journey-ring-circle">üëë</div>
                    <span class="journey-ring-label">Royal</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'filterCategory(\'Fashion Icon\')')">
                    <div class="journey-ring-circle">üëî</div>
                    <span class="journey-ring-label">Fashion</span>
                </div>
                <div class="journey-ring-item" onclick="journeyRingNavigate(this, 'showClub27()')">
                    <div class="journey-ring-circle">üïØ</div>
                    <span class="journey-ring-label">Club 27</span>
                </div>
            </div>
        </nav>
        <div class="flex items-center space-x-5 pl-4 shadow-[-10px_0_20px_rgba(0,0,0,0.5)]">
            <button onclick="toggleSearch()"
                class="text-gray-300 hover:text-white transition-colors p-2 -m-2 min-w-[44px] min-h-[44px] flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>

            <button id="profile-button" onclick="toggleProfileDropdown()" class="relative group"
                aria-label="Profile menu" aria-expanded="false" aria-controls="profile-dropdown" aria-haspopup="menu">
                <div
                    class="w-8 h-8 rounded-full bg-gold flex items-center justify-center hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-black" viewBox="0 0 20 20"
                        fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <div id="header-notif-dot"
                    class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-black animate-ping"
                    aria-hidden="true">
                </div>
                <div id="header-notif-dot-static"
                    class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-black"
                    aria-hidden="true">
                </div>
            </button>
        </div>
    </header>

    <div id="profile-dropdown-backdrop" class="profile-dropdown-backdrop" onclick="toggleProfileDropdown()"
        aria-hidden="true"></div>

    <div id="profile-dropdown" class="profile-dropdown" role="menu" aria-label="Profile menu">
        <div class="profile-menu-section">
            <div class="profile-menu-label">Account</div>
            <button class="profile-menu-item profile-menu-item-gold" onclick="showProfile(); toggleProfileDropdown();">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span>My Profile</span>
            </button>
            <button class="profile-menu-item" onclick="showMonetization(); toggleProfileDropdown();">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                <span>VIP Status</span>
            </button>
        </div>

        <div class="profile-menu-section">
            <div class="profile-menu-label">Preferences</div>
            <button class="profile-menu-item" onclick="showSettings(); toggleProfileDropdown();">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>Settings</span>
            </button>
            <button class="profile-menu-item"
                onclick="alert('Notification settings coming soon!'); toggleProfileDropdown();">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <span>Notifications</span>
            </button>
        </div>

        <div class="profile-menu-section">
            <div class="profile-menu-label">Actions</div>
            <button class="profile-menu-item" onclick="shareApp(); toggleProfileDropdown();">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                <span>Share App</span>
            </button>
            <button class="profile-menu-item" onclick="openSuggestModal(); toggleProfileDropdown();">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                <span>Suggest Legend</span>
            </button>
            <button class="profile-menu-item profile-menu-item-red"
                onclick="if(confirm('Sign out?')) { resetApp(); }">
                <svg class="profile-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span>Sign Out</span>
            </button>
        </div>
    </div>

    <div id="context-menu-backdrop" class="context-menu-backdrop" onclick="hideContextMenu()" aria-hidden="true"></div>

    <div id="context-menu" class="context-menu" role="menu" aria-label="Legend actions menu">
        <div class="context-menu-section" role="group" aria-labelledby="context-quick-actions-label">
            <div id="context-quick-actions-label" class="context-menu-label">Quick Actions</div>
            <button class="context-menu-item context-menu-item-gold" onclick="contextMenuAction('favorite')"
                role="menuitem" aria-label="Add or remove from favorites">
                <svg class="context-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                    aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <span id="context-fav-text">Add to Favorites</span>
            </button>
            <button class="context-menu-item" onclick="contextMenuAction('candle')" role="menuitem"
                aria-label="Light a candle">
                <svg class="context-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                    aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                </svg>
                <span>Light Candle</span>
            </button>
        </div>

        <div class="context-menu-section" role="group" aria-labelledby="context-share-label">
            <div id="context-share-label" class="context-menu-label">Share</div>
            <button class="context-menu-item" onclick="contextMenuAction('share')" role="menuitem"
                aria-label="Share this legend">
                <svg class="context-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                    aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                <span>Share Legend</span>
            </button>
        </div>

        <div class="context-menu-section" role="group" aria-labelledby="context-more-label">
            <div id="context-more-label" class="context-menu-label">More</div>
            <button class="context-menu-item" onclick="contextMenuAction('view')" role="menuitem"
                aria-label="View full details">
                <svg class="context-menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                    aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>View Full Details</span>
            </button>
        </div>
    </div>

    <div id="search-bar-container"
        class="hidden fixed top-16 w-full z-30 bg-black/95 backdrop-blur-xl border-b border-gold/20 px-4 py-3 shadow-2xl animate-in fade-in slide-in-from-top-2">
        <div class="relative max-w-7xl mx-auto flex items-center">
            <input type="text" id="search-input" onkeyup="filterLegends()" placeholder="Search name..."
                class="w-full bg-white/10 border border-white/10 rounded-full py-3 pl-4 pr-4 text-white placeholder-gray-400 focus:outline-none focus:border-gold transition-all">
            <button onclick="closeSearch()" class="ml-4 text-sm text-gray-400 hover:text-white">X</button>
        </div>
    </div>

    <main id="home-view" class="pt-24 px-4 max-w-7xl mx-auto fade-in">
        <div id="hero-section" class="mb-12 transition-all duration-500">
            <h2 class="text-2xl font-bold text-white mb-1 tracking-tight font-serif-custom">For You ‚Äì Today</h2>
            <p class="text-platinum text-sm mb-6 font-light tracking-wide">Places of Remembrance</p>
            <div id="hero-container"
                class="relative w-full h-[500px] md:h-[600px] rounded-3xl overflow-hidden bg-gray-900 border border-white/10 shadow-2xl cursor-pointer">
                <div class="w-full h-full animate-pulse bg-gray-900 flex items-center justify-center">
                    <p class="text-gold opacity-50">Loading Highlights...</p>
                </div>
            </div>
        </div>

        <div id="club27-header"
            class="hidden mb-12 relative rounded-3xl overflow-hidden border border-red-900/30 min-h-[400px]">
            <div class="absolute inset-0 bg-gradient-to-br from-black via-[#2a0505] to-black"></div>
            <div
                class="absolute bottom-0 left-0 right-0 h-1/2 bg-gradient-to-t from-red-900/40 to-transparent blur-3xl">
            </div>
            <div class="relative z-10 p-8 md:p-12 flex flex-col justify-center h-full min-h-[400px]">
                <div class="max-w-2xl">
                    <div class="text-5xl mb-4 opacity-90 animate-pulse">ü•Ä</div>
                    <h1 class="text-6xl md:text-8xl font-serif-custom text-white mb-6 leading-none">CLUB <span
                            class="text-red-600 italic font-serif-custom">27</span></h1>
                    <p
                        class="text-gray-300 text-sm md:text-base leading-relaxed font-light max-w-lg border-l-2 border-red-600 pl-6">
                        The 27 Club is one of music history‚Äôs darkest legends. It refers to iconic artists, mainly from
                        rock and blues, who all died at the age of 27.</p>
                </div>
            </div>
        </div>

        <div id="noble-ad-container" class="hidden mb-12"></div>

        <div id="official-playlists-section" class="hidden mb-12">
            <h3 class="text-xl font-bold text-white mb-4 tracking-tight">Official Soundtracks</h3>
            <div id="official-playlists-container" class="playlist-scroll-container">
                </div>
        </div>

        <h2 id="category-title" class="hidden text-3xl font-black text-white mb-8 uppercase tracking-tight pl-1 font-serif-custom"></h2>
        <div id="legends-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-20"></div>
    </main>

    <main id="monetization-view" class="hidden pt-24 px-4 max-w-7xl mx-auto fade-in h-screen overflow-y-auto pb-32">

        <div class="border-l-4 border-gold bg-white/5 p-6 mb-10 rounded-r-xl max-w-3xl mx-auto">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-1 h-6 bg-gold"></div>
                <h3 class="text-gold font-bold tracking-widest uppercase text-sm">Core Philosophy</h3>
            </div>
            <p class="italic text-gray-200 text-lg leading-relaxed font-serif-custom">"Remembered monetizes closeness,
                not memory.<br>Our users pay to connect deeper ‚Äì not to get access."</p>
        </div>

        <div class="flex justify-center mb-10">
            <div class="bg-gray-900 border border-white/10 p-1 rounded-full flex relative">
                <button onclick="setBilling('monthly')" id="btn-monthly"
                    class="px-6 py-2 rounded-full text-xs font-bold uppercase transition-all bg-gold text-black shadow-lg">Monthly</button>
                <button onclick="setBilling('yearly')" id="btn-yearly"
                    class="px-6 py-2 rounded-full text-xs font-bold uppercase transition-all text-gray-400 hover:text-white">Yearly
                    (-17%)</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto">

            <div
                class="bg-[#0A0A0A] border border-white/5 rounded-xl p-8 flex flex-col relative h-full transform hover:scale-[1.01] transition-transform duration-300">
                <div class="mb-4">
                    <span
                        class="bg-[#1A1A1A] text-gray-400 text-[10px] font-bold px-2 py-1 uppercase rounded border border-white/10">Entry</span>
                </div>
                <h3 class="text-3xl font-black text-white mb-1">FREE</h3>
                <p class="text-gray-400 text-xs mb-6">The cultural mission.</p>

                <div class="text-5xl font-bold text-white mb-1">$0</div>
                <div class="text-gray-500 text-[10px] uppercase tracking-widest mb-8">/ Always</div>

                <ul class="space-y-3 mb-6">
                    <li class="flex items-start gap-3 text-sm text-gray-300"><span
                            class="text-green-500 font-bold">‚úì</span> Discover Icons</li>
                    <li class="flex items-start gap-3 text-sm text-gray-300"><span
                            class="text-green-500 font-bold">‚úì</span> Read Biographies</li>
                    <li class="flex items-start gap-3 text-sm text-gray-400"><span class="text-gray-500">‚ö†</span> Light
                        Candle (1/day)</li>
                    <li class="flex items-start gap-3 text-sm text-gray-400"><span class="text-gray-500">‚ö†</span> Save
                        Favorites (Limited)</li>
                </ul>

                <details class="plan-details mb-6">
                    <summary
                        class="plan-details-summary cursor-pointer text-xs text-gray-400 hover:text-gold transition-colors uppercase tracking-wider font-bold flex items-center gap-2">
                        <span>Show all features</span>
                        <svg class="w-4 h-4 expand-icon-small transition-transform" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </summary>
                    <div class="plan-details-content mt-4 pt-4 border-t border-white/10 space-y-3">
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Auto-Translation</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            "For You" Feed</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Watch Trailers</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Ad-Free Experience</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Personal Collections</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Private Memorial Pages</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span> AI
                            Summaries & Timeline</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Export (PDF/Memorial)</div>
                    </div>
                </details>

                <button
                    class="w-full py-4 rounded-lg border border-white/10 bg-white/5 text-gray-500 text-xs font-bold uppercase cursor-default">Current
                    Plan</button>
            </div>

            <div
                class="bg-[#0E121B] border border-gold rounded-xl p-8 flex flex-col relative transform md:-translate-y-4 shadow-2xl shadow-gold/5 h-full hover:shadow-gold/10 transition-shadow duration-300">
                <div
                    class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gold text-black text-[10px] font-bold px-4 py-1 rounded-full uppercase tracking-widest">
                    Popular</div>

                <h3 class="text-3xl font-black text-white mt-4 mb-1">SUPPORTER</h3>
                <p class="text-gray-400 text-xs mb-6">For fans who want depth.</p>

                <div class="flex items-end gap-1 mb-1">
                    <div id="price-supporter" class="text-5xl font-bold text-white">$1.99</div>
                </div>
                <div id="cycle-supporter" class="text-gray-500 text-[10px] uppercase tracking-widest mb-8">/ Month</div>

                <ul class="space-y-3 mb-6">
                    <li class="flex items-start gap-3 text-sm text-white font-medium"><span class="text-gold">‚òÖ</span>
                        <strong>Unlimited</strong> Candles
                    </li>
                    <li class="flex items-start gap-3 text-sm text-white font-medium"><span class="text-gold">‚òÖ</span>
                        <strong>Unlimited</strong> Favorites
                    </li>
                    <li class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span>
                        <strong>Ad-Free Experience</strong>
                    </li>
                    <li class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span> Personal
                        Collections</li>
                </ul>

                <details class="plan-details mb-6">
                    <summary
                        class="plan-details-summary cursor-pointer text-xs text-gold hover:text-yellow-400 transition-colors uppercase tracking-wider font-bold flex items-center gap-2">
                        <span>Show all features</span>
                        <svg class="w-4 h-4 expand-icon-small transition-transform" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </summary>
                    <div class="plan-details-content mt-4 pt-4 border-t border-gold/20 space-y-3">
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Discover Icons</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Read Biographies</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Auto-Translation</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            "For You" Feed</div>
                        <div class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span> Watch
                            Trailers</div>
                        <div class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span>
                            Supporter Badge</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Private Memorial Pages</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span> AI
                            Summaries & Timeline</div>
                        <div class="flex items-start gap-3 text-sm text-gray-500"><span class="text-red-500">‚úï</span>
                            Export (PDF/Memorial)</div>
                    </div>
                </details>

                <button onclick="alert('Checkout integration coming in Phase 2')"
                    class="w-full py-4 rounded-lg bg-gold text-black text-xs font-bold uppercase hover:bg-yellow-400 transition-colors shadow-lg shadow-gold/20">Select
                    Plan</button>
            </div>

            <div
                class="bg-[#0A0A0A] border border-blue-900/50 rounded-xl p-8 flex flex-col relative h-full transform hover:scale-[1.01] transition-transform duration-300">
                <div class="mb-4">
                    <span
                        class="bg-blue-900/20 text-blue-400 text-[10px] font-bold px-2 py-1 uppercase rounded border border-blue-500/30">Premium</span>
                </div>

                <h3 class="text-3xl font-black text-white mb-1">LEGACY+</h3>
                <p class="text-gray-400 text-xs mb-6">Preserve what remains.</p>

                <div class="flex items-end gap-1 mb-1">
                    <div id="price-legacy" class="text-5xl font-bold text-white">$4.99</div>
                </div>
                <div id="cycle-legacy" class="text-gray-500 text-[10px] uppercase tracking-widest mb-8">/ Month</div>

                <ul class="space-y-3 mb-6">
                    <li class="flex items-start gap-3 text-sm text-gray-300"><span class="text-blue-500">‚úì</span>
                        Everything in Supporter</li>
                    <li class="flex items-start gap-3 text-sm text-gray-300"><span class="text-blue-500">‚úì</span>
                        Private Memorial Pages</li>
                    <li class="flex items-start gap-3 text-sm text-gray-300"><span class="text-blue-500">‚úì</span> AI
                        Summaries & Timeline</li>
                    <li class="flex items-start gap-3 text-sm text-gray-300"><span class="text-blue-500">‚úì</span> Export
                        (PDF/Memorial)</li>
                </ul>

                <details class="plan-details mb-6">
                    <summary
                        class="plan-details-summary cursor-pointer text-xs text-blue-400 hover:text-blue-300 transition-colors uppercase tracking-wider font-bold flex items-center gap-2">
                        <span>Show all features</span>
                        <svg class="w-4 h-4 expand-icon-small transition-transform" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </summary>
                    <div class="plan-details-content mt-4 pt-4 border-t border-blue-500/20 space-y-3">
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Discover Icons</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Read Biographies</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            Auto-Translation</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-green-500">‚úì</span>
                            "For You" Feed</div>
                        <div class="flex items-start gap-3 text-sm text-white font-medium"><span
                                class="text-gold">‚òÖ</span> Unlimited Candles</div>
                        <div class="flex items-start gap-3 text-sm text-white font-medium"><span
                                class="text-gold">‚òÖ</span> Unlimited Favorites</div>
                        <div class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span> Watch
                            Trailers</div>
                        <div class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span> Ad-Free
                            Experience</div>
                        <div class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span> Personal
                            Collections</div>
                        <div class="flex items-start gap-3 text-sm text-white"><span class="text-gold">‚úì</span>
                            Supporter Badge</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-blue-500">‚úì</span>
                            Create Personal Memories</div>
                        <div class="flex items-start gap-3 text-sm text-gray-300"><span class="text-blue-500">‚úì</span>
                            Store Text, Images & Quotes</div>
                    </div>
                </details>

                <button onclick="alert('Checkout integration coming in Phase 2')"
                    class="w-full py-4 rounded-lg border border-blue-500/50 text-blue-400 text-xs font-bold uppercase hover:bg-blue-900/20 transition-colors">Select
                    Plan</button>
            </div>
        </div>


        <div class="mt-16 mb-10 text-center">
            <button onclick="showProfile()"
                class="text-gray-500 hover:text-white text-xs font-bold uppercase tracking-[0.2em] border-b border-transparent hover:border-white transition-all pb-1">
                ‚Üê Back to Profile
            </button>
        </div>
    </main>

    <main id="favorites-view" class="hidden pt-24 px-4 max-w-7xl mx-auto fade-in h-screen">
        <div class="mb-8 flex items-center space-x-4"><button onclick="showProfile()"
                class="p-2 bg-white/5 rounded-full hover:bg-white/10"><svg class="h-5 w-5 text-gray-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg></button>
            <h2 class="text-2xl font-bold text-white font-serif-custom">Your Legacy Collection</h2>
        </div>
        <div id="favorites-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-20"></div>
    </main>

    <main id="candles-view" class="hidden pt-24 px-4 max-w-7xl mx-auto fade-in h-screen">
        <div class="mb-8 flex items-center space-x-4"><button onclick="showProfile()"
                class="p-2 bg-white/5 rounded-full hover:bg-white/10"><svg class="h-5 w-5 text-gray-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg></button>
            <h2 class="text-2xl font-bold text-white font-serif-custom">Your Tributes</h2>
        </div>
        <div id="candles-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-20"></div>
    </main>

    <main id="settings-view" class="hidden pt-24 px-6 max-w-lg mx-auto fade-in h-screen">
        <div class="mb-8 flex items-center space-x-4"><button onclick="showProfile()"
                class="p-2 bg-white/5 rounded-full hover:bg-white/10"><svg class="h-5 w-5 text-gray-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg></button>
            <h2 class="text-2xl font-bold text-white">Settings</h2>
        </div>
        <div class="space-y-6">
            <input type="text" id="settings-name-input" placeholder="Your Name"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white">
            <button onclick="showMonetization()"
                class="w-full bg-gradient-to-r from-gray-900 to-gray-800 border border-gold/30 p-4 rounded-xl flex items-center justify-between group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gold/20 flex items-center justify-center text-gold">‚òÖ</div>
                    <div class="text-left">
                        <p class="text-white font-bold text-sm">Membership</p>
                        <p class="text-gold text-xs">Become a Supporter</p>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gray-500 group-hover:text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            <button onclick="saveSettings()" class="w-full bg-gold text-black font-bold py-4 rounded-xl">SAVE</button>

            <div class="mt-8 pt-6 border-t border-white/10">
                <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-3">üõ† Dev Tools</h3>
                <div class="space-y-2">
                    <button onclick="devSetPermission('FREE')"
                        class="w-full bg-white/5 border border-white/10 text-white py-3 rounded-lg text-xs font-bold hover:bg-white/10 transition">Login
                        Free</button>
                    <button onclick="devSetPermission('SUPPORTER')"
                        class="w-full bg-white/5 border border-gold/30 text-gold py-3 rounded-lg text-xs font-bold hover:bg-gold/10 transition">Login
                        Premium</button>
                    <button onclick="devSetPermission('ADMIN')"
                        class="w-full bg-white/5 border border-blue-500/30 text-blue-400 py-3 rounded-lg text-xs font-bold hover:bg-blue-500/10 transition">Admin
                        Panel</button>
                </div>
            </div>

            <button onclick="resetApp()" class="w-full text-red-500 py-3 text-sm mt-6">Delete All Data</button>
        </div>
    </main>

    <section id="profile-view" class="hidden pt-28 px-6 max-w-lg mx-auto fade-in h-screen">
        <div class="flex flex-col items-center mb-12">
            <div class="relative mb-6">
                <div class="w-32 h-32 rounded-full bg-gradient-to-tr from-gold via-yellow-500 to-gold p-1 animate-pulse-slow"
                    style="box-shadow: 0 0 30px rgba(234, 179, 8, 0.6), 0 0 60px rgba(234, 179, 8, 0.3);">
                    <div class="w-full h-full rounded-full bg-black flex items-center justify-center overflow-hidden"
                        style="box-shadow: inset 0 0 20px rgba(234, 179, 8, 0.4);">
                        <span id="profile-avatar" class="text-5xl font-black text-white">ME</span>
                    </div>
                </div>
            </div>
            <h2 id="profile-name" class="text-3xl font-bold text-white mb-2 font-serif-custom">My Profile</h2>
            
            <div id="plan-label"
                class="bg-black border border-gold/50 px-4 py-1.5 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.2)] mb-2">
                <p class="text-gold text-[10px] tracking-[0.25em] uppercase font-bold">Free Member</p>
            </div>
            
            <div id="supporter-badge-profile" class="hidden bg-gradient-to-r from-gold/20 to-gold/10 border border-gold/40 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(234,179,8,0.2)]">
                <span class="text-gold">‚òÖ</span> SUPPORTER
            </div>
        </div>

        <div class="mb-10">
            <button onclick="showMonetization()"
                class="w-full bg-gradient-to-br from-black via-gray-900 to-black border-2 border-gold/60 p-5 rounded-2xl flex items-center justify-center gap-3 hover:border-gold transition-all duration-300 relative overflow-hidden group"
                style="box-shadow: 0 0 40px rgba(234, 179, 8, 0.15), inset 0 0 30px rgba(234, 179, 8, 0.05);">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-transparent via-gold/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000">
                </div>
                <div class="relative flex items-center gap-3">
                    <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z">
                        </path>
                    </svg>
                    <div class="text-left">
                        <p class="text-white text-sm font-black uppercase tracking-widest">Unlock Premium</p>
                        <p class="text-gold text-[9px] uppercase tracking-[0.2em] opacity-80">VIP Black Card</p>
                    </div>
                    <svg class="w-5 h-5 text-gold ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
            </button>
        </div>

        <div id="premium-features-section" class="hidden mb-8 space-y-3">
            <p class="text-gray-500 text-xs uppercase tracking-widest font-bold text-center mb-4">Premium Features</p>
            
            <button onclick="openCollections()" 
                class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-gold/10 to-gold/5 backdrop-blur-md border border-gold/20 rounded-xl hover:bg-gold/15 hover:border-gold/30 transition-all duration-300 group">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <div class="text-left">
                        <p class="text-sm font-medium text-white">Personal Collections</p>
                        <p class="text-xs text-gray-400">Organize your favorites</p>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gold group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            
            <button id="memorial-pages-btn" onclick="openMemorialPages()" 
                class="hidden w-full flex items-center justify-between p-4 bg-gradient-to-r from-blue-900/10 to-blue-900/5 backdrop-blur-md border border-blue-500/20 rounded-xl hover:bg-blue-900/15 hover:border-blue-500/30 transition-all duration-300 group">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    <div class="text-left">
                        <p class="text-sm font-medium text-white">Memorial Pages</p>
                        <p class="text-xs text-gray-400">Create private tributes</p>
                    </div>
                </div>
                <svg class="w-5 h-5 text-blue-400 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            
            <button id="export-btn" onclick="openExport()" 
                class="hidden w-full flex items-center justify-between p-4 bg-gradient-to-r from-blue-900/10 to-blue-900/5 backdrop-blur-md border border-blue-500/20 rounded-xl hover:bg-blue-900/15 hover:border-blue-500/30 transition-all duration-300 group">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <div class="text-left">
                        <p class="text-sm font-medium text-white">Export & Archive</p>
                        <p class="text-xs text-gray-400">Download as PDF</p>
                    </div>
                </div>
                <svg class="w-5 h-5 text-blue-400 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-12">
            <div onclick="showCandlesView()"
                class="glass-panel border border-white/20 rounded-2xl p-6 text-center cursor-pointer transition-all duration-400 hover:border-gold hover:shadow-[0_0_30px_rgba(234,179,8,0.4)] group">
                <div class="mb-3">
                    <svg class="w-8 h-8 mx-auto text-gold opacity-60 group-hover:opacity-100 transition-opacity"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 108 11a3 3 0 004.12 4.12z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <p id="profile-candle-count"
                    class="text-4xl font-bold text-white group-hover:text-gold transition-colors font-serif-custom">0
                </p>
                <p
                    class="text-gray-500 text-[9px] uppercase mt-2 tracking-[0.2em] font-bold group-hover:text-white transition-colors">
                    Tributes</p>
            </div>
            <div onclick="showFavoritesView()"
                class="glass-panel border border-white/20 rounded-2xl p-6 text-center cursor-pointer transition-all duration-400 hover:border-gold hover:shadow-[0_0_30px_rgba(234,179,8,0.4)] group">
                <div class="mb-3">
                    <svg class="w-8 h-8 mx-auto text-gold opacity-60 group-hover:opacity-100 transition-opacity"
                        fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <p id="profile-fav-count"
                    class="text-4xl font-bold text-white group-hover:text-gold transition-colors font-serif-custom">0
                </p>
                <p
                    class="text-gray-500 text-[9px] uppercase mt-2 tracking-[0.2em] font-bold group-hover:text-white transition-colors">
                    Collection</p>
            </div>
        </div>

        <div class="space-y-3">
            <button onclick="showSettings()"
                class="w-full flex items-center justify-between p-4 bg-white/5 backdrop-blur-md border border-white/10 rounded-xl hover:bg-white/10 hover:border-white/20 transition-all duration-300 group">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-gold transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">Account &
                        Settings</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 group-hover:text-gold transition-colors" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <button id="notif-btn"
                class="w-full flex items-center justify-between p-4 bg-white/5 backdrop-blur-md border border-white/10 rounded-xl hover:bg-white/10 hover:border-white/20 transition-all duration-300 group">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-gold transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <span id="notif-text"
                        class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">No new
                        messages</span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="notif-badge" class="hidden w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <svg class="w-5 h-5 text-gray-500 group-hover:text-gold transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
            </button>

            <div class="pt-6 mt-6 border-t border-white/5">
                <button onclick="resetApp()"
                    class="w-full flex items-center justify-between p-4 bg-white/5 backdrop-blur-md border border-red-900/30 rounded-xl hover:bg-red-900/10 hover:border-red-500/50 hover:shadow-[0_0_20px_rgba(220,38,38,0.3)] transition-all duration-300 group">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-red-500 group-hover:text-red-400 transition-colors" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span class="text-sm font-medium text-red-500 group-hover:text-red-400 transition-colors">Log
                            Out</span>
                    </div>
                    <svg class="w-5 h-5 text-red-500/50 group-hover:text-red-400 transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </section>

    <section id="detail-overlay" class="hidden fixed inset-0 z-50 bg-black animate-in fade-in">

        <button onclick="closeDetail()"
            class="fixed top-6 right-6 z-50 bg-black/50 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center border border-white/10 hover:bg-white/20 hover:border-white transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <button onclick="toggleFavorite()"
            class="fixed top-6 right-20 z-50 bg-black/50 backdrop-blur-md w-10 h-10 rounded-full flex items-center justify-center border border-white/10 transition-all">
            <svg id="fav-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white transition-colors"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        </button>

        <div class="absolute inset-0 z-0">
            <img id="detail-img" src="" class="w-full h-full object-cover opacity-60">
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
        </div>

        <div
            class="relative z-10 w-full h-full flex flex-col justify-start pt-64 md:pt-72 pb-12 px-4 md:px-12 overflow-y-auto no-scrollbar">

            <div class="max-w-3xl mx-auto w-full text-center overflow-hidden">
                <h1 id="detail-name"
                    class="text-xl md:text-6xl font-semibold text-white leading-snug mb-3 uppercase tracking-wide drop-shadow-2xl break-words">
                </h1>
                <p id="detail-dates"
                    class="text-gold font-mono text-[10px] md:text-xs tracking-[0.15em] mb-16 whitespace-nowrap overflow-hidden text-ellipsis">
                </p>

                <div
                    class="border-l-4 border-gold pl-6 py-1 text-left mb-10 mx-auto max-w-xl bg-black/30 backdrop-blur-sm rounded-r-xl overflow-hidden">
                    <p id="detail-quote"
                        class="text-xl md:text-2xl font-serif-custom text-white italic leading-relaxed break-words"></p>
                    <p id="detail-headline" class="text-gray-400 text-xs uppercase tracking-widest mt-2 break-words">
                    </p>
                </div>

                <div id="video-container" class="hidden mb-4 max-w-xl mx-auto">
                    <div id="video-wrapper"
                        class="aspect-video w-full bg-gray-900 rounded-xl overflow-hidden border border-white/10 relative">
                    </div>
                </div>

                <div id="partner-wrapper" class="hidden mb-12 mt-4 animate-fade-in">
                </div>

                <div class="max-w-xl mx-auto mb-12 relative group overflow-hidden">
                    <p id="detail-bio"
                        class="text-gray-300 leading-7 font-light text-base line-clamp-4 transition-all duration-500 break-words overflow-wrap-anywhere">
                    </p>
                    <button id="read-more-btn" onclick="toggleBio()"
                        class="text-gold text-[10px] font-bold uppercase tracking-widest mt-4 hover:text-white transition-colors hidden w-full text-center">
                        READ MORE
                    </button>
                </div>

                <div class="mb-12">
                    <p class="text-center text-xs text-gray-400 uppercase tracking-[0.15em] mb-6 font-medium">Leave Your Tribute</p>
                    
                    <div class="tribute-container mb-6">
                        <div class="flex flex-col items-center">
                            <div id="candle-circle" onclick="toggleCandle()" class="candle-container">
                                <svg id="candle-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flame-icon"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 108 11a3 3 0 004.12 4.12z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                            <p id="candle-text" class="text-[9px] font-bold text-gray-500 tracking-[0.2em] uppercase mt-2">Light</p>
                        </div>

                        <div class="flex flex-col items-center">
                            <div id="flower-circle" onclick="toggleFlower()" class="flower-container">
                                <svg id="flower-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flower-icon"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                            </div>
                            <p id="flower-text" class="text-[9px] font-bold text-gray-500 tracking-[0.2em] uppercase mt-2">Bloom</p>
                        </div>
                    </div>

                    <div class="text-center space-y-2">
                        <p class="text-xs text-gold font-mono"><span id="candle-count">0</span> Candles ‚Ä¢ <span id="flower-count">0</span> Flowers</p>
                        <p id="community-text" class="text-[10px] text-platinum font-medium tracking-wider"><span id="community-count">0</span> fans left their tribute here</p>
                    </div>
                </div>

                <button onclick="closeDetail()"
                    class="border border-white/20 bg-black/40 backdrop-blur text-white text-[10px] font-bold uppercase tracking-[0.2em] px-8 py-3 rounded-full hover:bg-white hover:text-black transition-colors">
                    Return to Legends
                </button>
            </div>
        </div>
    </section>

    <div id="suggest-overlay"
        class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-4 animate-in fade-in">
        <div class="relative w-full max-w-md">
            <button onclick="closeSuggest()"
                class="absolute -top-12 right-0 text-gray-400 hover:text-white transition-all hover:scale-110 z-10 w-10 h-10 rounded-full bg-white/5 backdrop-blur-md flex items-center justify-center border border-white/10 hover:border-gold/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div
                class="bg-gradient-to-br from-gray-900/90 via-black/90 to-gray-900/90 border border-gold/30 rounded-3xl p-8 shadow-2xl relative overflow-hidden backdrop-blur-xl">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-gold/10 via-transparent to-gold/5 pointer-events-none">
                </div>
                <div class="absolute -top-20 -right-20 w-40 h-40 bg-gold/10 rounded-full blur-3xl"></div>

                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-gold to-yellow-600 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(234,179,8,0.4)]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-white leading-tight font-serif-custom">Suggest a Legend
                            </h2>
                            <p class="text-gray-400 text-xs mt-1">Who deserves to be remembered?</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-400 text-xs uppercase font-bold tracking-wider mb-2">Name of
                                Legend *</label>
                            <input type="text" id="suggest-name"
                                class="w-full bg-white/5 border border-white/20 rounded-xl p-3 text-white placeholder-gray-500 focus:border-gold focus:outline-none focus:ring-2 focus:ring-gold/30 transition-all backdrop-blur-sm"
                                placeholder="e.g. David Bowie">
                        </div>

                        <div>
                            <label class="block text-gray-400 text-xs uppercase font-bold tracking-wider mb-2">Category
                                *</label>
                            <select id="suggest-category"
                                class="w-full bg-white/5 border border-white/20 rounded-xl p-3 text-white focus:border-gold focus:outline-none focus:ring-2 focus:ring-gold/30 transition-all appearance-none cursor-pointer backdrop-blur-sm">
                                <option value="Musician">Musician</option>
                                <option value="Actor">Actor</option>
                                <option value="DJ & Producer">DJ & Producer</option>
                                <option value="Sport Icon">Sport Icon</option>
                                <option value="Visionary">Visionary</option>
                                <option value="Royal">Royal</option>
                                <option value="Fashion Icon">Fashion Icon</option>
                                <option value="Club 27">Club 27</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-400 text-xs uppercase font-bold tracking-wider mb-2">Why?
                                (Optional)</label>
                            <textarea id="suggest-reason" rows="3"
                                class="w-full bg-white/5 border border-white/20 rounded-xl p-3 text-white placeholder-gray-500 focus:border-gold focus:outline-none focus:ring-2 focus:ring-gold/30 transition-all resize-none backdrop-blur-sm"
                                placeholder="Tell us why they belong here..."></textarea>
                        </div>

                        <button onclick="submitSuggestion()" id="submit-suggest-btn"
                            class="w-full bg-gradient-to-r from-gold to-yellow-600 text-black font-bold py-4 rounded-xl hover:shadow-[0_0_40px_rgba(234,179,8,0.6)] transition-all duration-300 mt-6 uppercase tracking-wider text-sm flex items-center justify-center gap-2 hover:scale-[1.02]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                            Send Suggestion
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <a href="https://open.spotify.com/playlist/37i9dQZF1DXcBWIGoYBM5M" target="_blank" id="radio-fab"
        class="fixed bottom-24 right-4 z-30 bg-black border border-[#1DB954] text-[#1DB954] p-3 rounded-full shadow-[0_0_15px_rgba(29,185,84,0.5)] hover:bg-[#1DB954] hover:text-black hover:scale-105 transition-all duration-300 group flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19V6l12-2v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-2" />
        </svg>
    </a>



    <nav class="fixed bottom-0 w-full z-40 bg-black/90 backdrop-blur-xl border-t border-white/5 px-6 flex justify-around items-center"
        style="padding-top: 1rem; padding-bottom: max(2rem, calc(2rem + env(safe-area-inset-bottom)));">
        <button onclick="showHome()" id="nav-home" class="flex flex-col items-center space-y-1 text-gold"><span
                class="text-[11px] font-bold uppercase">Home</span></button>
        <button onclick="toggleSearch()" id="nav-search"
            class="flex flex-col items-center space-y-1 text-gray-500"><span
                class="text-[11px] font-bold uppercase">Search</span></button>
        <button onclick="openSuggestModal()" id="nav-suggest"
            class="flex flex-col items-center space-y-1 text-gray-500 hover:text-gold transition-colors"><span
                class="text-[11px] font-bold uppercase">Suggest</span></button>
        <button onclick="showProfile()" id="nav-profile"
            class="flex flex-col items-center space-y-1 text-gray-500"><span
                class="text-[11px] font-bold uppercase">Profile</span></button>
    </nav>

    <script>
        // --- 1. CONFIGURATION ---
        const supabaseUrl = 'https://aahsaqygohmykhagbihk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhaHNhcXlnb2hteWtoYWdiaWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODQzMDcsImV4cCI6MjA4MjY2MDMwN30.yRGsxsWC9EGO5rR1cy4_9Clt6FvJ05cqRo9qHlVyE-E';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        // üî• SECURITY CHECK: Sofortiger Rauswurf, wenn nicht eingeloggt
        (async function protectApp() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                // Nicht eingeloggt? Zur√ºck zur Startseite!
                window.location.href = "/"; 
            }
        })();

        // --- PLAN-BASED FEATURE CONTROL (Apple Review Safe) ---
        // Features are now controlled by user plan, not feature flags
        const PLAN_FEATURES = {
            FREE: [],
            SUPPORTER: ['collections', 'unlimited_candles', 'unlimited_favorites', 'ad_free', 'trailers', 'flowers', 'supporter_badge'],
            'LEGACY+': ['collections', 'unlimited_candles', 'unlimited_favorites', 'ad_free', 'trailers', 'flowers', 'supporter_badge', 'memorial_pages', 'ai_summaries', 'export', 'personal_memories', 'eternal_coordinates']
        };

        // --- 2. ASSETS (PARTNER LOGOS) ---
        // Offizielle PNG/SVG URLs f√ºr die Partner
        const partnerLogos = {
            'netflix': 'https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg',
            'eventim': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Eventim_logo.svg/2560px-Eventim_logo.svg.png',
            'disney': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Disney%2B_logo.svg/1280px-Disney%2B_logo.svg.png',
            'prime': 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/Prime_Video.png/800px-Prime_Video.png',
            'spotify': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/2048px-Spotify_logo_without_text.svg.png',
            'apple': 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Apple_TV_Plus_Logo.svg/2560px-Apple_TV_Plus_Logo.svg.png',
            'hbo': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/HBO_Max_Logo.svg/2560px-HBO_Max_Logo.svg.png'
        };

        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================

        // Pagination & Loading
        let currentOffset = 0;
        const BATCH_SIZE = 24;
        let isLoading = false;
        let endOfList = false;

        // Filtering & Search
        let activeFilter = 'ALL';
        let searchTerm = '';
        let allLegendsCache = [];

        // Current View State
        let currentDetailId = null;
        let activeCampaign = null;

        // ============================================================================
        // ANIMATION SYSTEM - Glass Namespace (FLIP Transitions)
        // ============================================================================
        class GlassNamespaceManager {
            constructor() {
                this.elements = new Map();
                this.activeTransitions = new Set();
            }

            // Register an element with a unique ID
            register(id, element) {
                if (!element) return;
                this.elements.set(id, element);
            }

            // FLIP Animation: morph element from one state to another
            async morph(id, callback, options = {}) {
                const element = this.elements.get(id);
                if (!element || this.activeTransitions.has(id)) return;

                this.activeTransitions.add(id);

                // FIRST: Get initial position
                const first = element.getBoundingClientRect();

                // Execute callback (changes DOM)
                await callback();

                // LAST: Get final position
                const last = element.getBoundingClientRect();

                // INVERT: Calculate difference
                const deltaX = first.left - last.left;
                const deltaY = first.top - last.top;
                const deltaW = first.width / last.width;
                const deltaH = first.height / last.height;

                // PLAY: Animate from inverted to final
                element.animate([
                    {
                        transform: `translate(${deltaX}px, ${deltaY}px) scale(${deltaW}, ${deltaH})`,
                        opacity: options.fadeFrom || 1
                    },
                    {
                        transform: 'translate(0, 0) scale(1, 1)',
                        opacity: 1
                    }
                ], {
                    duration: options.duration || 400,
                    easing: options.easing || 'cubic-bezier(0.4, 0, 0.2, 1)',
                    fill: 'both'
                });

                setTimeout(() => this.activeTransitions.delete(id), options.duration || 400);
            }

            // Smooth scale animation for state changes
            pulse(id, options = {}) {
                const element = this.elements.get(id);
                if (!element) return;

                element.animate([
                    { transform: 'scale(1)', opacity: 1 },
                    { transform: `scale(${options.scale || 1.05})`, opacity: options.opacity || 1 },
                    { transform: 'scale(1)', opacity: 1 }
                ], {
                    duration: options.duration || 300,
                    easing: 'ease-in-out'
                });
            }

            // Glass glow effect animation
            glow(id, color = 'rgba(234, 179, 8, 0.6)', duration = 500) {
                const element = this.elements.get(id);
                if (!element) return;

                element.animate([
                    { boxShadow: element.style.boxShadow || 'none' },
                    { boxShadow: `0 0 40px ${color}, inset 0 0 20px ${color}` },
                    { boxShadow: element.style.boxShadow || 'none' }
                ], {
                    duration: duration,
                    easing: 'ease-in-out'
                });
            }
        }

        // Initialize the namespace manager
        const glassNamespace = new GlassNamespaceManager();

        // --- 4. AUTH & PERMISSIONS (PREMIUM CHECK) ---
        const Permissions = {
            currentPlan: 'FREE',
            async init() {
                const { data: { session } } = await db.auth.getSession();
                if (!session) { this.updateUI(); return; }
                const { data: sub } = await db.from('user_subscriptions').select('plan_id').eq('user_id', session.user.id).eq('is_active', true).maybeSingle();
                if (sub) {
                    const { data: planInfo } = await db.from('plans').select('name').eq('id', sub.plan_id).single();
                    if (planInfo) this.currentPlan = planInfo.name;
                }
                this.updateUI();
            },
            updateUI() { 
                const planLabel = document.getElementById('plan-label');
                if (planLabel) {
                    planLabel.innerHTML = `<p class="text-gold text-[10px] tracking-[0.25em] uppercase font-bold">${this.currentPlan} Member</p>`;
                }
                this.updateBadges();
            },
            updateBadges() {
                // Update Supporter Badge in Profile
                const profileBadge = document.getElementById('supporter-badge-profile');
                if (profileBadge) {
                    if (this.isSupporter() || this.isLegacy()) {
                        profileBadge.classList.remove('hidden');
                        profileBadge.innerHTML = this.isLegacy() 
                            ? '<span class="text-blue-400">‚òÖ</span> LEGACY+ MEMBER'
                            : '<span class="text-gold">‚òÖ</span> SUPPORTER';
                    } else {
                        profileBadge.classList.add('hidden');
                    }
                }
            },
            isPremium() { return this.currentPlan === 'SUPPORTER' || this.currentPlan === 'LEGACY+'; },
            isSupporter() { return this.currentPlan === 'SUPPORTER'; },
            isLegacy() { return this.currentPlan === 'LEGACY+'; },
            hasFeature(feature) {
                // Check if user's plan includes this feature
                const planFeatures = PLAN_FEATURES[this.currentPlan] || [];
                return planFeatures.includes(feature.toLowerCase());
            },
            canAccessFeature(featureName) {
                // Universal feature access check
                const featureMap = {
                    'collections': 'collections',
                    'memorial_pages': 'memorial_pages',
                    'ai_summaries': 'ai_summaries',
                    'export': 'export',
                    'personal_memories': 'personal_memories',
                    'eternal_coordinates': 'eternal_coordinates',
                    'trailers': 'trailers',
                    'flowers': 'flowers'
                };
                
                const mappedFeature = featureMap[featureName] || featureName;
                return this.hasFeature(mappedFeature);
            },
            getRequiredPlan(featureName) {
                // Return which plan is required for a feature
                if (PLAN_FEATURES.SUPPORTER.includes(featureName)) return 'SUPPORTER';
                if (PLAN_FEATURES['LEGACY+'].includes(featureName)) return 'LEGACY+';
                return 'FREE';
            }
        };

        // --- 5. CORE ENGINE (INFINITE SCROLL) ---
        async function fetchLegends(reset = false) {
            if (isLoading || (endOfList && !reset)) return;
            isLoading = true;

            if (reset) {
                currentOffset = 0;
                endOfList = false;
                document.getElementById('legends-grid').innerHTML = '';
            }

            let query;
            if (activeFilter === 'CLUB 27') {
                query = db.from('club27').select('*').range(currentOffset, currentOffset + BATCH_SIZE - 1);
            } else {
                query = db.from('legends').select('*').range(currentOffset, currentOffset + BATCH_SIZE - 1);
                if (activeFilter !== 'ALL' && activeFilter !== 'SEARCH' && activeFilter !== 'CLUB 27') {
                    query = query.ilike('category', `%${activeFilter}%`);
                } else if (activeFilter === 'SEARCH' && searchTerm) {
                    query = query.ilike('name', `%${searchTerm}%`);
                }
                query = query.order('name', { ascending: true });
            }

            const { data, error } = await query;
            if (error) { console.error("DB Error:", error); isLoading = false; return; }

            if (data && data.length > 0) {
                data.forEach(item => {
                    if (activeFilter === 'CLUB 27') {
                        item.bio = item.description;
                        item.dates = item.lifespan;
                        item.category = 'CLUB 27';
                    }
                    if (!allLegendsCache.find(x => x.id === item.id)) allLegendsCache.push(item);
                });

                const grid = document.getElementById('legends-grid');
                data.forEach(l => {
                    grid.insertAdjacentHTML('beforeend', createCard(l));
                });

                currentOffset += data.length;
                if (reset && activeFilter === 'ALL') startHeroRotation(data);

            } else {
                endOfList = true;
                if (reset) document.getElementById('legends-grid').innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No legends found.</p>';
            }

            isLoading = false;
        }

        // --- 6. EVENT LISTENERS & NAVIGATION ---
        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 300) {
                if (!document.getElementById('home-view').classList.contains('hidden')) {
                    fetchLegends(false);
                }
            }
        });

        function resetHeaders() {
            document.getElementById('hero-section').classList.add('hidden');
            document.getElementById('club27-header').classList.add('hidden');
            document.getElementById('category-title').classList.add('hidden');
        }

        function hideAllViews() {
            const views = ['home-view', 'profile-view', 'favorites-view', 'candles-view', 'settings-view', 'monetization-view'];
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        function showHome() {
            hideAllViews(); resetHeaders();
            activeFilter = 'ALL';
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('hero-section').classList.remove('hidden');
            updateNavColors('home');
            fetchLegends(true);
            loadActiveCampaign(); // Load ad banner for FREE users
            loadOfficialPlaylists(); // Load playlists
        }

        // --- OFFICIAL PLAYLISTS FUNCTIONS ---
        async function loadOfficialPlaylists() {
            const { data, error } = await db.from('playlists')
                .select('*')
                .eq('is_active', true)
                .order('sort_order', { ascending: true });

            if (error) {
                console.error('Error loading playlists:', error);
                return;
            }

            const container = document.getElementById('official-playlists-container');
            const section = document.getElementById('official-playlists-section');

            if (!data || data.length === 0) {
                section.classList.add('hidden');
                return;
            }

            container.innerHTML = '';
            section.classList.remove('hidden');

            data.forEach(playlist => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.onclick = () => openPlaylistModal(playlist.id, playlist.title, playlist.spotify_url);

                card.innerHTML = `
                    <img src="${playlist.cover_url}" alt="${playlist.title}" class="playlist-cover"
                         onerror="this.src='https://via.placeholder.com/140/1a1a1a/666?text=${encodeURIComponent(playlist.title)}'">
                    <div class="playlist-play-overlay">
                        <div class="playlist-play-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-black" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="playlist-title">${playlist.title}</div>
                `;

                container.appendChild(card);
            });
        }

        function openPlaylistModal(playlistId, title, spotifyUrl) {
            // Extract playlist ID from Spotify URL - handles query parameters like ?si=...
            // Matches patterns like:
            // https://open.spotify.com/playlist/37i9dQZF1DXcBWIGoYBM5M
            // https://open.spotify.com/playlist/37i9dQZF1DXcBWIGoYBM5M?si=abc123
            const playlistIdMatch = spotifyUrl.match(/playlist\/([a-zA-Z0-9]+)/);
            if (!playlistIdMatch || !playlistIdMatch[1]) {
                alert('Invalid Spotify playlist URL');
                return;
            }
            const spotifyPlaylistId = playlistIdMatch[1];

            // Create modal overlay with premium cinematic styling
            const modal = document.createElement('div');
            modal.id = 'playlist-modal';
            modal.className = 'fixed inset-0 z-50 bg-black/98 backdrop-blur-xl flex items-center justify-center p-4 animate-in fade-in';

            modal.innerHTML = `
                <div class="relative w-full max-w-2xl">
                    <button onclick="closePlaylistModal()" 
                        class="absolute -top-12 right-0 text-gray-400 hover:text-white transition-all hover:scale-110 z-10 w-10 h-10 rounded-full bg-white/5 backdrop-blur-md flex items-center justify-center border border-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    
                    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 border border-gold/20 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-gold/5 via-transparent to-transparent pointer-events-none"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-gold rounded-full flex items-center justify-center animate-pulse">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="text-[10px] text-gold font-bold uppercase tracking-widest mb-1">NOW PLAYING</p>
                                    <h2 class="text-2xl font-bold text-white leading-tight">${title}</h2>
                                </div>
                            </div>
                            
                            <div class="spotify-embed-container rounded-2xl overflow-hidden shadow-2xl border border-white/10" style="box-shadow: 0 0 40px rgba(234, 179, 8, 0.15);">
                                <iframe src="https://open.spotify.com/embed/playlist/${spotifyPlaylistId}?utm_source=generator&theme=0" 
                                        width="100%" height="480" frameborder="0" allowfullscreen="" 
                                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                                        loading="lazy"></iframe>
                            </div>
                            
                            <p class="text-gray-500 text-xs text-center mt-6 uppercase tracking-widest">
                                Curated by <span class="text-gold">Remembered</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closePlaylistModal() {
            const modal = document.getElementById('playlist-modal');
            if (modal) {
                modal.remove();
            }
        }

        function showClub27() {
            hideAllViews(); resetHeaders();
            activeFilter = 'CLUB 27';
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('club27-header').classList.remove('hidden');
            updateNavColors('home');
            fetchLegends(true);
        }

        function filterCategory(c) {
            hideAllViews(); resetHeaders();
            activeFilter = c;
            document.getElementById('home-view').classList.remove('hidden');
            const titleEl = document.getElementById('category-title');
            titleEl.innerText = c;
            titleEl.classList.remove('hidden');
            updateNavColors('home');
            fetchLegends(true);
        }

        function filterLegends() {
            const input = document.getElementById('search-input');
            searchTerm = input.value;
            activeFilter = 'SEARCH';
            fetchLegends(true);
        }

        // ============================================================================
        // UI COMPONENTS - Legend Cards
        // ============================================================================
        function createCard(l) {
            const i = l.image_url || 'https://placehold.co/600x800';
            const d = getCardDate(l.dates, l.death_date);
            const is27 = (l.category && l.category.includes('27')) || (l.tags && l.tags.includes('Club 27')) || activeFilter === 'CLUB 27';
            const dateColor = is27 ? '#EF4444' : '#EAB308';
            const catColor = is27 ? '#EF4444' : '#EAB308';
            const catText = is27 ? 'CLUB 27' : (l.category || 'LEGEND');
            const cardClass = is27 ? "club27-card" : "legend-card";
            const imgClass = is27 ? "" : "grayscale group-hover:grayscale-0";
            const nameHover = is27 ? 'group-hover:text-red-500' : 'group-hover:text-[#EAB308]';

            // APPLE 2026: Add context menu support with enhanced event handling
            // ENHANCED: Accessibility attributes for screenreaders
            const ariaLabel = `${l.name}, ${catText}, ${d}. Click to view details, right-click or long-press for more options.`;

            return `<div 
                onclick="handleCardClick('${l.id}')" 
                oncontextmenu="event.preventDefault(); showContextMenu(event, '${l.id}'); return false;"
                ontouchstart="handleTouchStart(event, '${l.id}')"
                ontouchend="handleTouchEnd()"
                class="${cardClass} relative group aspect-[3/4] rounded-xl overflow-hidden cursor-pointer bg-black animate-in fade-in"
                role="button"
                aria-label="${ariaLabel}"
                tabindex="0">
                <img src="${i}" alt="${l.name}" class="w-full h-full object-cover transition-all duration-700 ${imgClass}">
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent opacity-90" aria-hidden="true"></div>
                <div class="absolute bottom-0 left-0 p-4 w-full">
                    <h2 class="text-white font-bold text-lg leading-tight mb-1 transition-colors ${nameHover}">${l.name}</h2>
                    <p style="color: ${dateColor} !important;" class="text-[10px] font-mono leading-tight mb-1.5 opacity-100 break-words">${d}</p>
                    <p style="color: ${catColor} !important;" class="text-[9px] font-bold tracking-[0.2em] uppercase transition-colors opacity-100">${catText}</p>
                </div>
            </div>`;
        }

        // ============================================================================
        // UI COMPONENTS - Detail View
        // ============================================================================
        async function openDetail(id) {
            let l = allLegendsCache.find(x => x.id === id);
            if (!l) {
                const table = activeFilter === 'CLUB 27' ? 'club27' : 'legends';
                const { data } = await db.from(table).select('*').eq('id', id).single();
                l = data;
                if (activeFilter === 'CLUB 27' && l) { l.bio = l.description; l.dates = l.lifespan; }
            }
            if (!l) return;

            currentDetailId = id;
            document.getElementById('detail-img').src = l.image_url;
            document.getElementById('detail-name').innerText = l.name;
            document.getElementById('detail-headline').innerText = l.headline || "";
            document.getElementById('detail-quote').innerText = l.quote || "";

            // US DATE FORMAT
            let dateStr = "";
            if (l.dates) dateStr += `* ${l.dates} `;
            if (l.death_date) {
                try {
                    const d = new Date(l.death_date);
                    const usDate = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    dateStr += `‚Äî ‚Ä† ${usDate}`;
                } catch (e) { }
            }
            document.getElementById('detail-dates').innerText = dateStr;

            // --- A) PARTNER BUTTON LOGIC (BUSINESS) ---
            const pWrapper = document.getElementById('partner-wrapper');
            pWrapper.innerHTML = '';

            let url = l.streaming_url;
            let type = l.partner_type || 'netflix';

            // Secondary partner
            let url2 = l.partner_2_url;
            let type2 = l.partner_2_type || 'netflix';

            // Check if at least one valid URL exists
            if ((url && url.length > 5) || (url2 && url2.length > 5)) {
                pWrapper.classList.remove('hidden');

                // Primary partner button
                if (url && url.length > 5) {
                    // SPOTIFY INTEGRATION: Render embed instead of button (CASE-INSENSITIVE)
                    if (type && type.toLowerCase() === 'spotify') {
                        // Convert Spotify URL to embed format
                        let embedUrl = url;

                        // Handle different Spotify URL formats
                        if (url.includes('open.spotify.com/')) {
                            // Extract the type and ID from the URL
                            const urlParts = url.replace('https://', '').replace('http://', '').split('/');
                            const spotifyType = urlParts[1]; // 'track', 'album', 'playlist', etc.
                            const spotifyId = urlParts[2]?.split('?')[0]?.split('#')[0]; // Remove query params and hashes

                            if (spotifyId) {
                                // Build embed URL
                                embedUrl = `https://open.spotify.com/embed/${spotifyType}/${spotifyId}`;
                            }
                        }

                        pWrapper.innerHTML += `
                        <div class="spotify-embed-container" style="margin-bottom: 12px;">
                            <iframe src="${embedUrl}" 
                                width="100%" 
                                height="80" 
                                frameborder="0" 
                                allowtransparency="true" 
                                allow="encrypted-media"
                                style="border-radius: 12px; box-shadow: 0 0 15px rgba(29, 185, 84, 0.3);"
                            ></iframe>
                        </div>`;
                    } else {
                        // Regular partner button (Netflix, Disney+, etc.)
                        let btnColor = 'glow-' + type;
                        let logoUrl = partnerLogos[type] || partnerLogos['netflix'];
                        let btnText = (type === 'eventim') ? 'GET TICKETS' : 'WATCH NOW';

                        pWrapper.innerHTML += `
                        <a href="${url}" target="_blank" class="partner-btn-base ${btnColor} w-full py-4 px-6 rounded-xl flex items-center justify-between group cursor-pointer mb-3">
                            <img src="${logoUrl}" class="h-8 w-auto object-contain max-w-[100px]" alt="${type}">
                            <div class="text-right">
                                <p class="text-white font-black uppercase tracking-widest text-sm group-hover:text-white transition-colors">${btnText}</p>
                                <p class="text-[9px] text-gray-400 uppercase tracking-[0.2em] mt-1">OFFICIAL LINK</p>
                            </div>
                        </a>`;
                    }
                }

                // Secondary partner button
                if (url2 && url2.length > 5) {
                    // Check if secondary is also Spotify (CASE-INSENSITIVE)
                    if (type2 && type2.toLowerCase() === 'spotify') {
                        let embedUrl2 = url2;

                        // Handle different Spotify URL formats
                        if (url2.includes('open.spotify.com/')) {
                            const urlParts = url2.replace('https://', '').replace('http://', '').split('/');
                            const spotifyType = urlParts[1];
                            const spotifyId = urlParts[2]?.split('?')[0]?.split('#')[0];

                            if (spotifyId) {
                                embedUrl2 = `https://open.spotify.com/embed/${spotifyType}/${spotifyId}`;
                            }
                        }

                        pWrapper.innerHTML += `
                        <div class="spotify-embed-container" style="margin-bottom: 12px;">
                            <iframe src="${embedUrl2}" 
                                width="100%" 
                                height="80" 
                                frameborder="0" 
                                allowtransparency="true" 
                                allow="encrypted-media"
                                style="border-radius: 12px; box-shadow: 0 0 15px rgba(29, 185, 84, 0.3);"
                            ></iframe>
                        </div>`;
                    } else {
                        let btnColor2 = 'glow-' + type2;
                        let logoUrl2 = partnerLogos[type2] || partnerLogos['netflix'];
                        let btnText2 = (type2 === 'eventim') ? 'GET TICKETS' : 'WATCH NOW';

                        pWrapper.innerHTML += `
                        <a href="${url2}" target="_blank" class="partner-btn-base ${btnColor2} w-full py-4 px-6 rounded-xl flex items-center justify-between group cursor-pointer">
                            <img src="${logoUrl2}" class="h-8 w-auto object-contain max-w-[100px]" alt="${type2}">
                            <div class="text-right">
                                <p class="text-white font-black uppercase tracking-widest text-sm group-hover:text-white transition-colors">${btnText2}</p>
                                <p class="text-[9px] text-gray-400 uppercase tracking-[0.2em] mt-1">OFFICIAL LINK</p>
                            </div>
                        </a>`;
                    }
                }
            } else {
                pWrapper.classList.add('hidden');
            }

            // --- B) VIDEO LOGIC (TRAILER) ---
            const vContainer = document.getElementById('video-container');
            const vWrapper = document.getElementById('video-wrapper');

            if (l.trailer_url) {
                vContainer.classList.remove('hidden');

                // Get CLEAN ID for Thumbnail
                let videoId = "";
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = l.trailer_url.match(regExp);
                if (match && match[2].length === 11) { videoId = match[2]; }

                // The Thumbnail URL
                const thumb = videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : l.image_url;

                // CHECK: Is User Premium?
                if (Permissions.isPremium()) {
                    // PREMIUM: Show Thumbnail first -> Click -> Iframe (Prevents "Video Unavailable" ugly error)
                    vWrapper.innerHTML = `
                        <div onclick="playVideo('${videoId}')" class="relative w-full h-full cursor-pointer group">
                            <img src="${thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-2xl group-hover:scale-110 transition-transform">
                                    <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>`;
                } else {
                    // FREE: Show Thumbnail + Gate
                    vWrapper.innerHTML = `
                        <div onclick="showMonetization()" class="relative w-full h-full cursor-pointer">
                            <img src="${thumb}" class="w-full h-full object-cover gate-blur opacity-50">
                            <div class="gate-overlay">
                                <div class="gate-badge">üîí SUPPORTER ONLY</div>
                                <p class="text-white text-xs font-light tracking-widest uppercase">Tap to Unlock Trailer</p>
                            </div>
                        </div>`;
                }
            } else { vContainer.classList.add('hidden'); }

            // --- BIO Logic ---
            const bioEl = document.getElementById('detail-bio');
            const btn = document.getElementById('read-more-btn');
            bioEl.innerText = l.bio || "";
            bioEl.classList.add('line-clamp-4');
            btn.innerText = "READ MORE";
            if (l.bio && l.bio.length > 200) btn.classList.remove('hidden');
            else btn.classList.add('hidden');

            // Candles & Flowers Update
            const isLit = getMyCandles().includes(id);
            const circle = document.getElementById('candle-circle');
            const text = document.getElementById('candle-text');
            if (isLit) { 
                text.innerText = "LIT"; 
                text.classList.add('text-gold'); 
                circle.classList.add('candle-active'); 
            } else { 
                text.innerText = "LIGHT"; 
                text.classList.remove('text-gold'); 
                circle.classList.remove('candle-active'); 
            }

            // Flowers Update with Premium Check
            const hasFlower = getMyFlowers().includes(id);
            const flowerCircle = document.getElementById('flower-circle');
            const flowerText = document.getElementById('flower-text');
            
            // STEP 6: Show lock icon for FREE users
            if (!canUseFlower() && !hasFlower) {
                flowerText.innerText = "LOCKED";
                flowerText.classList.add('text-gray-600');
                flowerCircle.classList.add('opacity-50');
                flowerCircle.style.cursor = 'not-allowed';
            } else if (hasFlower) { 
                flowerText.innerText = "BLOOMED"; 
                flowerText.classList.add('text-platinum'); 
                flowerCircle.classList.add('flower-active');
                flowerCircle.classList.remove('opacity-50');
                flowerCircle.style.cursor = 'pointer';
            } else { 
                flowerText.innerText = "BLOOM"; 
                flowerText.classList.remove('text-platinum', 'text-gray-600'); 
                flowerCircle.classList.remove('flower-active', 'opacity-50');
                flowerCircle.style.cursor = 'pointer';
            }
            
            // Candle Update with Daily Limit for FREE
            if (!Permissions.isPremium()) {
                const limit = getCandleLimit();
                const candleStatus = document.createElement('p');
                candleStatus.className = 'text-[9px] text-gray-500 text-center mt-8 tracking-wider';
                candleStatus.innerHTML = `Free: ${limit.used}/${limit.limit} candles today`;
                
                // Add after tribute container
                const tributeParent = document.querySelector('.tribute-container').parentElement;
                const existingStatus = tributeParent.querySelector('.candle-status-text');
                if (existingStatus) existingStatus.remove();
                candleStatus.classList.add('candle-status-text');
                tributeParent.insertBefore(candleStatus, tributeParent.querySelector('.text-center'));
            }

            updateFavBtnState(id);
            
            // Update counts with Apple-Style formatting
            const candleCountNum = l.candles || 0;
            const flowerCountNum = l.flowers || 0;
            const communityCount = candleCountNum + flowerCountNum;
            
            document.getElementById('candle-count').innerText = candleCountNum.toLocaleString('en-US');
            document.getElementById('flower-count').innerText = flowerCountNum.toLocaleString('en-US');
            document.getElementById('community-count').innerText = communityCount.toLocaleString('en-US');
            
            // Apple-Style dynamic community text
            const communityText = document.getElementById('community-text');
            if (communityCount === 0) {
                communityText.innerHTML = '<span id="community-count">0</span> tributes yet ¬∑ be the first';
            } else if (communityCount === 1) {
                communityText.innerHTML = '<span id="community-count">1</span> fan left their tribute here';
            } else {
                communityText.innerHTML = `<span id="community-count">${communityCount.toLocaleString('en-US')}</span> fans left their tribute here`;
            }
            
            document.getElementById('detail-overlay').classList.remove('hidden');
            document.getElementById('radio-fab').classList.add('hidden');
        }

        // ENHANCED: FLIP Transition from Card to Detail View
        let lastClickedCardElement = null;

        async function openDetailWithTransition(id, cardElement) {
            // Store the clicked card for potential reverse animation
            lastClickedCardElement = cardElement;

            // Get detail overlay before showing it
            const detailOverlay = document.getElementById('detail-overlay');
            const detailImg = document.getElementById('detail-img');

            // Register elements with glassNamespace if not already done
            if (cardElement && !glassNamespace.elements.has(`card-${id}`)) {
                glassNamespace.register(`card-${id}`, cardElement);
            }
            glassNamespace.register('detail-transition', detailImg);

            // If we have a card element, perform FLIP transition
            if (cardElement) {
                // First, load the detail content (without showing it)
                await openDetail(id);

                // Now make detail visible but transparent for transition
                detailOverlay.style.opacity = '0';
                detailOverlay.classList.remove('hidden');

                // Perform FLIP morph animation
                await glassNamespace.morph('detail-transition', async () => {
                    // Fade in the detail overlay
                    detailOverlay.style.opacity = '1';
                }, {
                    duration: 400,
                    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                    fadeFrom: 0
                });
            } else {
                // Fallback: No transition, just open normally
                await openDetail(id);
            }
        }

        // --- 8. HELPER FUNCTIONS ---
        function playVideo(id) {
            document.getElementById('video-wrapper').innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>`;
        }

        function toggleBio() {
            const bio = document.getElementById('detail-bio');
            const btn = document.getElementById('read-more-btn');
            if (bio.classList.contains('line-clamp-4')) { bio.classList.remove('line-clamp-4'); btn.innerText = "SHOW LESS"; }
            else { bio.classList.add('line-clamp-4'); btn.innerText = "READ MORE"; }
        }

        function closeDetail() {
            const overlay = document.getElementById('detail-overlay');
            overlay.classList.add('hidden');
            overlay.style.opacity = ''; // Reset opacity for next transition
            document.getElementById('video-wrapper').innerHTML = "";
            document.getElementById('radio-fab').classList.remove('hidden');
        }
        // LUXURY TRIBUTE SYSTEM: Candles & Flowers (WITH STEP 6 GATES)
        async function toggleCandle() {
            const t = document.getElementById('candle-text'); 
            const circle = document.getElementById('candle-circle');
            if (t.innerText === "LIT") return;
            
            // STEP 6: Check permission for FREE users
            if (!Permissions.isPremium()) {
                const limit = getCandleLimit();
                if (!limit.canLight) {
                    showPremiumGate('candle');
                    return;
                }
            }
            
            t.innerText = "LIT"; 
            t.classList.add('text-gold'); 
            circle.classList.add('candle-active');
            
            // Increment daily counter for FREE users
            if (!Permissions.isPremium()) {
                incrementCandleCount();
            }
            
            let c = getMyCandles(); 
            if (!c.includes(currentDetailId)) { 
                c.push(currentDetailId); 
                saveMyCandles(c); 
            }
            
            let countEl = document.getElementById('candle-count');
            let currentVal = parseInt(countEl.innerText.replace(/,/g, ''));
            countEl.innerText = (currentVal + 1).toLocaleString('en-US');
            
            // Update community count
            updateCommunityCount(1, 0);
            
            const table = activeFilter === 'CLUB 27' ? 'club27' : 'legends';
            await db.from(table).update({ candles: db.raw('candles + 1') }).eq('id', currentDetailId);
        }

        async function toggleFlower() {
            const t = document.getElementById('flower-text'); 
            const circle = document.getElementById('flower-circle');
            if (t.innerText === "BLOOMED") return;
            
            // STEP 6: Flowers are PREMIUM-ONLY
            if (!canUseFlower()) {
                showPremiumGate('flower');
                return;
            }
            
            t.innerText = "BLOOMED"; 
            t.classList.add('text-platinum'); 
            circle.classList.add('flower-active');
            
            let f = getMyFlowers(); 
            if (!f.includes(currentDetailId)) { 
                f.push(currentDetailId); 
                saveMyFlowers(f); 
            }
            
            let countEl = document.getElementById('flower-count');
            let currentVal = parseInt(countEl.innerText.replace(/,/g, ''));
            countEl.innerText = (currentVal + 1).toLocaleString('en-US');
            
            // Update community count
            updateCommunityCount(0, 1);
            
            const table = activeFilter === 'CLUB 27' ? 'club27' : 'legends';
            await db.from(table).update({ flowers: db.raw('flowers + 1') }).eq('id', currentDetailId);
        }

        function updateCommunityCount(candleIncrement, flowerIncrement) {
            const communityEl = document.getElementById('community-count');
            const communityText = document.getElementById('community-text');
            let currentVal = parseInt(communityEl.innerText.replace(/,/g, ''));
            const newVal = currentVal + candleIncrement + flowerIncrement;
            
            // Update with Apple-Style formatting
            communityEl.innerText = newVal.toLocaleString('en-US');
            
            // Update dynamic text
            if (newVal === 0) {
                communityText.innerHTML = '<span id="community-count">0</span> tributes yet ¬∑ be the first';
            } else if (newVal === 1) {
                communityText.innerHTML = '<span id="community-count">1</span> fan left their tribute here';
            } else {
                communityText.innerHTML = `<span id="community-count">${newVal.toLocaleString('en-US')}</span> fans left their tribute here`;
            }
        }

        function toggleFavorite() { if (!currentDetailId) return; let f = getFavorites(); if (f.includes(currentDetailId)) f = f.filter(i => i !== currentDetailId); else f.push(currentDetailId); saveFavorites(f); updateFavBtnState(currentDetailId); }
        function updateFavBtnState(id) { const i = document.getElementById('fav-icon'); if (getFavorites().includes(id)) { i.setAttribute('fill', 'currentColor'); i.classList.add('text-red-500'); i.classList.remove('text-white'); } else { i.setAttribute('fill', 'none'); i.classList.remove('text-red-500'); i.classList.add('text-white'); } }

        function getCardDate(d1, d2) { if (!d1) return ''; let b = d1.match(/(\d{4})/); b = b ? b[0] : ''; let d = d2 ? d2.split('-')[0] : ''; return d ? `${b} ‚Äì ${d}` : d1; }

        // ============================================================================
        // UI COMPONENTS - Search & Navigation
        // ============================================================================
        function toggleSearch() { const s = document.getElementById('search-bar-container'); if (s.classList.contains('hidden')) { s.classList.remove('hidden'); document.getElementById('search-input').focus(); } else document.getElementById('search-bar-container').classList.add('hidden'); }
        function closeSearch() { document.getElementById('search-bar-container').classList.add('hidden'); showHome(); }
        function showProfile() { 
            hideAllViews(); 
            document.getElementById('profile-view').classList.remove('hidden'); 
            updateNavColors('profile'); 
            document.getElementById('profile-candle-count').innerText = getMyCandles().length; 
            document.getElementById('profile-fav-count').innerText = getFavorites().length;
            
            // Show/hide premium features section
            const premiumSection = document.getElementById('premium-features-section');
            const memorialBtn = document.getElementById('memorial-pages-btn');
            const exportBtn = document.getElementById('export-btn');
            
            if (Permissions.isPremium()) {
                premiumSection.classList.remove('hidden');
                
                // Show LEGACY+ exclusive features
                if (Permissions.isLegacy()) {
                    if (memorialBtn) memorialBtn.classList.remove('hidden');
                    if (exportBtn) exportBtn.classList.remove('hidden');
                } else {
                    if (memorialBtn) memorialBtn.classList.add('hidden');
                    if (exportBtn) exportBtn.classList.add('hidden');
                }
            } else {
                premiumSection.classList.add('hidden');
            }
        }
        function showSettings() { hideAllViews(); document.getElementById('settings-view').classList.remove('hidden'); }

        // ============================================================================
        // UI COMPONENTS - Profile Dropdown
        // ============================================================================
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            const backdrop = document.getElementById('profile-dropdown-backdrop');
            const button = document.getElementById('profile-button');
            const isActive = dropdown.classList.contains('active');

            if (isActive) {
                dropdown.classList.remove('active');
                backdrop.classList.remove('active');
                if (button) button.setAttribute('aria-expanded', 'false');
            } else {
                dropdown.classList.add('active');
                backdrop.classList.add('active');
                if (button) button.setAttribute('aria-expanded', 'true');
            }
        }

        // ============================================================================
        // ACTIONS - Share
        // ============================================================================
        function shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'Remembered - Legends App',
                    text: 'Remember the icons who shaped our world.',
                    url: window.location.href
                }).catch(() => { });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('‚úì Link copied to clipboard!');
                });
            }
        }

        // ============================================================================
        // UI COMPONENTS - Context Menu
        // ============================================================================

        // Context menu state
        let contextMenuLegendId = null;
        let longPressTimer = null;
        let longPressTriggered = false;

        // Haptic feedback helper with mobile detection
        function triggerHapticFeedback(pattern = 50) {
            const isMobileDevice = /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || ('ontouchstart' in window && navigator.maxTouchPoints > 0);

            if (isMobileDevice && navigator.vibrate) {
                try {
                    navigator.vibrate(pattern);
                } catch (e) {
                    console.debug('Vibration API not supported');
                }
            }
        }

        function showContextMenu(event, legendId) {
            event.preventDefault();
            event.stopPropagation();

            contextMenuLegendId = legendId;
            const menu = document.getElementById('context-menu');
            const backdrop = document.getElementById('context-menu-backdrop');

            // Update Favorite text
            const favText = document.getElementById('context-fav-text');
            const isFav = getFavorites().includes(legendId);
            favText.innerText = isFav ? 'Remove from Favorites' : 'Add to Favorites';

            // Position menu at cursor/touch point
            let x = event.clientX || (event.touches && event.touches[0].clientX) || 0;
            let y = event.clientY || (event.touches && event.touches[0].clientY) || 0;

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;

            // Show menu
            menu.classList.add('active');
            backdrop.classList.add('active');

            // ENHANCED: Auto-dismiss event listeners for robust cleanup
            attachContextMenuDismissListeners();

            // ENHANCED: Adaptive positioning with ALL edge cases
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                const safeMargin = 10;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // Check RIGHT edge
                if (rect.right > viewportWidth - safeMargin) {
                    x = viewportWidth - rect.width - safeMargin;
                }

                // Check LEFT edge
                if (rect.left < safeMargin) {
                    x = safeMargin;
                }

                // Check BOTTOM edge
                if (rect.bottom > viewportHeight - safeMargin) {
                    y = viewportHeight - rect.height - safeMargin;
                }

                // Check TOP edge (rare but possible)
                if (rect.top < safeMargin) {
                    y = safeMargin;
                }

                // Apply adjusted position
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
            }, 10);
        }

        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            const backdrop = document.getElementById('context-menu-backdrop');
            menu.classList.remove('active');
            backdrop.classList.remove('active');
            contextMenuLegendId = null;

            // ENHANCED: Clean up event listeners to prevent memory leaks
            removeContextMenuDismissListeners();
        }

        // ENHANCED: Auto-dismiss event listeners for scroll, resize, orientation change
        function attachContextMenuDismissListeners() {
            // Remove any existing listeners first to prevent duplicates
            removeContextMenuDismissListeners();

            // Add listeners for various dismiss scenarios
            window.addEventListener('scroll', hideContextMenu, { passive: true, capture: true });
            window.addEventListener('resize', hideContextMenu, { passive: true });
            window.addEventListener('orientationchange', hideContextMenu, { passive: true });

            // Also close on escape key
            document.addEventListener('keydown', handleContextMenuEscape);
        }

        function removeContextMenuDismissListeners() {
            window.removeEventListener('scroll', hideContextMenu, { capture: true });
            window.removeEventListener('resize', hideContextMenu);
            window.removeEventListener('orientationchange', hideContextMenu);
            document.removeEventListener('keydown', handleContextMenuEscape);
        }

        function handleContextMenuEscape(event) {
            if (event.key === 'Escape') {
                hideContextMenu();
            }
        }

        function contextMenuAction(action) {
            if (!contextMenuLegendId) return;

            switch (action) {
                case 'favorite':
                    let favs = getFavorites();
                    if (favs.includes(contextMenuLegendId)) {
                        favs = favs.filter(id => id !== contextMenuLegendId);
                        showVelvetRopeToast('Removed from Favorites');
                    } else {
                        favs.push(contextMenuLegendId);
                        showVelvetRopeToast('‚úì Added to Favorites');
                    }
                    saveFavorites(favs);
                    break;

                case 'candle':
                    openDetail(contextMenuLegendId);
                    setTimeout(() => {
                        const candleBtn = document.getElementById('candle-circle');
                        if (candleBtn) candleBtn.click();
                    }, 500);
                    break;

                case 'share':
                    const legendData = allLegendsCache.find(l => l.id === contextMenuLegendId);
                    if (legendData && navigator.share) {
                        navigator.share({
                            title: legendData.name,
                            text: `Remember ${legendData.name} on Remembered`,
                            url: window.location.href
                        }).catch(() => { });
                    } else if (legendData) {
                        // Fallback: copy to clipboard
                        navigator.clipboard.writeText(window.location.href).then(() => {
                            showVelvetRopeToast('‚úì Link copied!');
                        }).catch(() => {
                            showVelvetRopeToast('Unable to share');
                        });
                    }
                    break;

                case 'view':
                    openDetail(contextMenuLegendId);
                    break;
            }

            hideContextMenu();
        }

        // ENHANCED: Long-press support with click conflict prevention
        function handleTouchStart(event, legendId) {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showContextMenu(event, legendId);

                // ENHANCED: Haptic feedback with mobile detection
                triggerHapticFeedback(50);
            }, 500); // 500ms long press
        }

        function handleTouchEnd() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // Prevent click if long-press was triggered
        // ENHANCED: Prevent click if long-press was triggered + Handle FLIP transition
        function handleCardClick(legendId) {
            if (longPressTriggered) {
                longPressTriggered = false;
                return;
            }

            // Find the card element that was clicked (event target's closest card)
            const cardElement = event?.target?.closest('.legend-card, .club27-card');

            // Use transition if card element is found, otherwise fallback to normal
            if (cardElement) {
                openDetailWithTransition(legendId, cardElement);
            } else {
                openDetail(legendId);
            }
        }

        async function showFavoritesView() {
            hideAllViews(); document.getElementById('favorites-view').classList.remove('hidden');
            const ids = getFavorites();
            const g = document.getElementById('favorites-grid'); g.innerHTML = '';
            if (!ids.length) { g.innerHTML = '<p class="text-gray-500">Empty.</p>'; return; }
            const { data } = await db.from('legends').select('*').in('id', ids);
            if (data) data.forEach(l => g.innerHTML += createCard(l));
        }
        async function showCandlesView() {
            hideAllViews(); document.getElementById('candles-view').classList.remove('hidden');
            const ids = getMyCandles();
            const g = document.getElementById('candles-grid'); g.innerHTML = '';
            if (!ids.length) { g.innerHTML = '<p class="text-gray-500">Empty.</p>'; return; }
            const { data } = await db.from('legends').select('*').in('id', ids);
            if (data) data.forEach(l => g.innerHTML += createCard(l));
        }
        function showMonetization() { hideAllViews(); document.getElementById('monetization-view').classList.remove('hidden'); }

        function openSuggestModal() { document.getElementById('suggest-overlay').classList.remove('hidden'); }
        function closeSuggest() {
            document.getElementById('suggest-overlay').classList.add('hidden');
            // Clear form
            document.getElementById('suggest-name').value = '';
            document.getElementById('suggest-category').value = 'Musician';
            document.getElementById('suggest-reason').value = '';
        }
        async function submitSuggestion() {
            const n = document.getElementById('suggest-name').value;
            const c = document.getElementById('suggest-category').value;
            const r = document.getElementById('suggest-reason').value;

            if (!n) {
                alert('Please enter a name');
                return;
            }

            const btn = document.getElementById('submit-suggest-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Sending...';
            btn.disabled = true;

            const suggestionData = { name: n, category: c };
            if (r) suggestionData.reason = r;

            const { error } = await db.from('suggestions').insert([suggestionData]);
            
            if (error) {
                console.error("Suggestion Error:", error);
                alert('Error sending suggestion. Please try again.');
            } else {
                closeSuggest();
                alert('Thank you! Your suggestion has been submitted.');
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // --- 10. BILLING LOGIC (FIXED) ---
        function setBilling(mode) {
            const btnM = document.getElementById('btn-monthly');
            const btnY = document.getElementById('btn-yearly');

            const priceSupporter = document.getElementById('price-supporter');
            const priceLegacy = document.getElementById('price-legacy');
            const cycleSupporter = document.getElementById('cycle-supporter');
            const cycleLegacy = document.getElementById('cycle-legacy');

            // Mobile card elements
            const mobilePriceSupporter = document.getElementById('mobile-price-supporter');
            const mobilePriceLegacy = document.getElementById('mobile-price-legacy');
            const mobileCycleSupporter = document.getElementById('mobile-cycle-supporter');
            const mobileCycleLegacy = document.getElementById('mobile-cycle-legacy');

            if (mode === 'monthly') {
                // Active: Monthly
                btnM.className = "px-6 py-2 rounded-full text-xs font-bold uppercase transition-all bg-gold text-black shadow-lg";
                btnY.className = "px-6 py-2 rounded-full text-xs font-bold uppercase transition-all text-gray-400 hover:text-white";

                priceSupporter.innerText = "$1.99";
                cycleSupporter.innerText = "/ MONTH";
                priceLegacy.innerText = "$4.99";
                cycleLegacy.innerText = "/ MONTH";

                // Update mobile cards
                if (mobilePriceSupporter) mobilePriceSupporter.innerText = "$1.99";
                if (mobilePriceLegacy) mobilePriceLegacy.innerText = "$4.99";
                if (mobileCycleSupporter) mobileCycleSupporter.innerText = "/ Month";
                if (mobileCycleLegacy) mobileCycleLegacy.innerText = "/ Month";
            } else {
                // Active: Yearly
                btnY.className = "px-6 py-2 rounded-full text-xs font-bold uppercase transition-all bg-gold text-black shadow-lg";
                btnM.className = "px-6 py-2 rounded-full text-xs font-bold uppercase transition-all text-gray-400 hover:text-white";

                priceSupporter.innerText = "$19.99";
                cycleSupporter.innerText = "/ YEAR (2 MONTHS FREE)";
                priceLegacy.innerText = "$49.99";
                cycleLegacy.innerText = "/ YEAR (2 MONTHS FREE)";

                // Update mobile cards
                if (mobilePriceSupporter) mobilePriceSupporter.innerText = "$19.99";
                if (mobilePriceLegacy) mobilePriceLegacy.innerText = "$49.99";
                if (mobileCycleSupporter) mobileCycleSupporter.innerText = "/ Year (2 months free)";
                if (mobileCycleLegacy) mobileCycleLegacy.innerText = "/ Year (2 months free)";
            }
        }

        function showVelvetRopeToast(msg) { const div = document.createElement('div'); div.className = "fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-900 border border-gold/30 text-gold px-6 py-3 rounded-full text-xs font-bold uppercase tracking-widest shadow-2xl z-[70] animate-in fade-in slide-in-from-bottom-4"; div.innerHTML = `<span class="opacity-70 mr-2">üîí</span> ${msg}`; document.body.appendChild(div); setTimeout(() => div.remove(), 3000); }
        function updateNavColors(active) { const b = "flex flex-col items-center space-y-1 text-gray-500"; const a = "flex flex-col items-center space-y-1 text-gold";['nav-home', 'nav-search', 'nav-suggest', 'nav-profile'].forEach(id => document.getElementById(id).className = b); if (active === 'home') document.getElementById('nav-home').className = a; if (active === 'profile') document.getElementById('nav-profile').className = a; }

        // ============================================================================
        // ACTIONS - User Data & Settings
        // ============================================================================
        function loadUserData() { const n = localStorage.getItem('user_name'); if (n) { document.getElementById('profile-name').innerText = n; document.getElementById('profile-avatar').innerText = n[0]; } }
        function saveSettings() { const n = document.getElementById('settings-name-input').value; if (n) localStorage.setItem('user_name', n); showProfile(); }
        function resetApp() { if (confirm("Reset?")) { localStorage.clear(); location.reload(); } }

        // ============================================================================
        // ACTIONS - Favorites, Candles & Flowers (LUXURY TRIBUTE SYSTEM)
        // ============================================================================
        function getFavorites() { return JSON.parse(localStorage.getItem('my_favorites') || '[]'); }
        function getMyCandles() { return JSON.parse(localStorage.getItem('my_candles') || '[]'); }
        function getMyFlowers() { return JSON.parse(localStorage.getItem('my_flowers') || '[]'); }
        function saveFavorites(a) { localStorage.setItem('my_favorites', JSON.stringify(a)); }
        function saveMyCandles(a) { localStorage.setItem('my_candles', JSON.stringify(a)); }
        function saveMyFlowers(a) { localStorage.setItem('my_flowers', JSON.stringify(a)); }

        // ============================================================================
        // STEP 6: GATE & REALITY MODE - Premium Limits (Apple-Style)
        // ============================================================================
        
        // Candle Limit System (1 per day for FREE users)
        function getCandleLimit() {
            const today = new Date().toDateString();
            const lastCandle = localStorage.getItem('last_candle_date');
            const candleCount = parseInt(localStorage.getItem('daily_candle_count') || '0');
            
            // Reset counter if it's a new day
            if (lastCandle !== today) {
                localStorage.setItem('last_candle_date', today);
                localStorage.setItem('daily_candle_count', '0');
                return { used: 0, limit: 1, canLight: true };
            }
            
            return { 
                used: candleCount, 
                limit: 1, 
                canLight: candleCount < 1 
            };
        }
        
        function incrementCandleCount() {
            const count = parseInt(localStorage.getItem('daily_candle_count') || '0');
            localStorage.setItem('daily_candle_count', (count + 1).toString());
        }
        
        // Flower Permission Check (Premium-only)
        function canUseFlower() {
            return Permissions.isPremium();
        }
        
        // Flyover Permission Check
        function canUseFlyover() {
            return Permissions.isPremium();
        }
        
        // Premium Gate Modal (Zen & Glass - Poetisch, nicht verk√§uferisch)
        function showPremiumGate(feature) {
            const modal = document.createElement('div');
            modal.id = 'premium-gate-modal';
            modal.className = 'fixed inset-0 z-[100] bg-black/98 backdrop-blur-3xl flex items-center justify-center p-6 animate-in fade-in';
            modal.onclick = () => closePremiumGate();
            
            modal.innerHTML = `
                <div class="relative w-full max-w-lg" onclick="event.stopPropagation();">
                    <button onclick="closePremiumGate()" 
                        class="absolute -top-14 right-0 text-gray-500 hover:text-white transition-all w-8 h-8 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    
                    <div class="bg-black/40 backdrop-blur-2xl border border-white/10 rounded-3xl p-12 shadow-2xl relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-gold/5 via-transparent to-transparent pointer-events-none"></div>
                        
                        <div class="relative z-10 text-center space-y-8">
                            <div class="space-y-4">
                                <p class="text-gray-400 text-sm font-light tracking-wide leading-relaxed">
                                    This place holds more than memory.
                                </p>
                                <h2 class="text-3xl font-light text-white tracking-tight font-serif-custom">
                                    Unlock the Legacy Experience.
                                </h2>
                            </div>
                            
                            <div class="flex items-center justify-center gap-6 py-6 opacity-60">
                                <div class="text-2xl">üïØÔ∏è</div>
                                <div class="text-2xl">üå∏</div>
                                <div class="text-2xl">üó∫Ô∏è</div>
                                <div class="text-2xl">‚ú®</div>
                            </div>
                            
                            <div class="space-y-3 pt-4">
                                <button onclick="showMonetization(); closePremiumGate();" 
                                    class="w-full bg-white text-black font-medium py-4 rounded-2xl hover:bg-gray-100 transition-all text-sm tracking-wide">
                                    Unlock Legacy
                                </button>
                                <button onclick="closePremiumGate()" 
                                    class="w-full text-gray-400 hover:text-white font-light py-3 text-sm tracking-wide transition-all">
                                    Continue Free
                                </button>
                            </div>
                            
                            <p class="text-gray-600 text-xs pt-4">
                                From $1.99/month
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Haptic feedback
            triggerHapticFeedback(50);
        }
        
        function closePremiumGate() {
            const modal = document.getElementById('premium-gate-modal');
            if (modal) modal.remove();
        }

        // ============================================================================
        // PREMIUM FEATURE MODALS (Apple Review Safe)
        // ============================================================================
        
        function openCollections() {
            if (!Permissions.canAccessFeature('collections')) {
                const required = Permissions.getRequiredPlan('collections');
                showUpgradeModal(required, 'Organize your favorite legends into custom collections.');
                return;
            }
            // Feature is available - show placeholder for now
            showComingSoonModal('Personal Collections', 'This feature is being crafted and will launch soon!');
        }
        
        function openMemorialPages() {
            if (!Permissions.canAccessFeature('memorial_pages')) {
                const required = Permissions.getRequiredPlan('memorial_pages');
                showUpgradeModal(required, 'Create private memorial pages for your personal memories and tributes.');
                return;
            }
            // Feature is available - show placeholder for now
            showComingSoonModal('Private Memorial Pages', 'Memorial pages builder launching soon. Create beautiful tributes for your loved ones.');
        }
        
        function openExport() {
            if (!Permissions.canAccessFeature('export')) {
                const required = Permissions.getRequiredPlan('export');
                showUpgradeModal(required, 'Export legends as beautifully formatted PDFs for archiving and sharing.');
                return;
            }
            // Feature is available - show placeholder for now
            showComingSoonModal('Export & Archive', 'PDF export feature launching soon. Download legends for offline viewing.');
        }
        
        // Coming Soon Modal (Feature Flag Placeholder)
        function showComingSoonModal(featureName, description) {
            const modal = document.createElement('div');
            modal.id = 'coming-soon-modal';
            modal.className = 'fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-in fade-in';
            modal.onclick = () => closeComingSoonModal();
            
            modal.innerHTML = `
                <div class="relative w-full max-w-md" onclick="event.stopPropagation();">
                    <button onclick="closeComingSoonModal()" 
                        class="absolute -top-12 right-0 text-gray-400 hover:text-white transition-all w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    
                    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 border border-gold/20 rounded-3xl p-10 shadow-2xl relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-gold/5 via-transparent to-transparent pointer-events-none"></div>
                        
                        <div class="relative z-10 text-center space-y-6">
                            <div class="w-16 h-16 bg-gold/10 rounded-full flex items-center justify-center mx-auto border border-gold/30">
                                <svg class="w-8 h-8 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">${featureName}</h2>
                                <p class="text-gray-400 text-sm leading-relaxed">${description}</p>
                            </div>
                            
                            <div class="pt-4">
                                <button onclick="closeComingSoonModal()" 
                                    class="w-full bg-gold/10 border border-gold/30 text-gold font-medium py-3 rounded-xl hover:bg-gold/20 transition-all text-sm">
                                    Got it
                                </button>
                            </div>
                            
                            <p class="text-gray-600 text-xs">
                                You'll be notified when this feature launches
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeComingSoonModal() {
            const modal = document.getElementById('coming-soon-modal');
            if (modal) modal.remove();
        }
        
        // Upgrade Modal (For Non-Premium Users)
        function showUpgradeModal(requiredPlan, featureDescription) {
            const modal = document.createElement('div');
            modal.id = 'upgrade-modal';
            modal.className = 'fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-in fade-in';
            modal.onclick = () => closeUpgradeModal();
            
            modal.innerHTML = `
                <div class="relative w-full max-w-md" onclick="event.stopPropagation();">
                    <button onclick="closeUpgradeModal()" 
                        class="absolute -top-12 right-0 text-gray-400 hover:text-white transition-all w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    
                    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 border border-blue-500/30 rounded-3xl p-10 shadow-2xl relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-transparent to-transparent pointer-events-none"></div>
                        
                        <div class="relative z-10 text-center space-y-6">
                            <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto border border-blue-500/30">
                                <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                            </div>
                            
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">${requiredPlan} Feature</h2>
                                <p class="text-gray-400 text-sm leading-relaxed">${featureDescription}</p>
                            </div>
                            
                            <div class="space-y-3 pt-4">
                                <button onclick="showMonetization(); closeUpgradeModal();" 
                                    class="w-full bg-blue-500 text-white font-medium py-4 rounded-xl hover:bg-blue-600 transition-all text-sm">
                                    Upgrade to ${requiredPlan}
                                </button>
                                <button onclick="closeUpgradeModal()" 
                                    class="w-full text-gray-400 hover:text-white font-light py-3 text-sm">
                                    Maybe Later
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeUpgradeModal() {
            const modal = document.getElementById('upgrade-modal');
            if (modal) modal.remove();
        }

        // ============================================================================
        // DEV TOOLS
        // ============================================================================
        window.devLogin = async (e, p) => { await db.auth.signInWithPassword({ email: e, password: p }); location.reload(); };
        window.devLogout = async () => { await db.auth.signOut(); location.reload(); };

        // ============================================================================
        // PLAN SIMULATION SYSTEM (Admin-Controlled)
        // ============================================================================
        
        function devSetPermission(plan) {
            // Validate plan
            const validPlans = ['FREE', 'SUPPORTER', 'LEGACY+'];
            if (!validPlans.includes(plan)) {
                alert('‚ùå Invalid plan. Use: FREE, SUPPORTER, or LEGACY+');
                return;
            }
            
            Permissions.currentPlan = plan;
            localStorage.setItem('dev_permission', plan);
            Permissions.updateUI();
            
            // Show detailed feature breakdown
            const features = PLAN_FEATURES[plan] || [];
            const featureList = features.length > 0 ? features.join(', ') : 'Basic access only';
            
            alert(`‚úÖ Plan activated: ${plan}\n\nüì¶ Available features:\n${featureList}\n\nRefresh any view to see changes.`);
            
            // Auto-refresh current view
            const currentView = getCurrentView();
            if (currentView === 'profile') {
                showProfile();
            } else if (currentView === 'home') {
                showHome();
            }
        }

        function loadDevPermission() {
            const devPlan = localStorage.getItem('dev_permission');
            if (devPlan) {
                Permissions.currentPlan = devPlan;
                Permissions.updateUI();
                console.log(`üîß DEV MODE: Plan loaded from localStorage: ${devPlan}`);
            }
        }
        
        function getCurrentView() {
            if (!document.getElementById('profile-view').classList.contains('hidden')) return 'profile';
            if (!document.getElementById('home-view').classList.contains('hidden')) return 'home';
            if (!document.getElementById('monetization-view').classList.contains('hidden')) return 'monetization';
            if (!document.getElementById('favorites-view').classList.contains('hidden')) return 'favorites';
            if (!document.getElementById('candles-view').classList.contains('hidden')) return 'candles';
            if (!document.getElementById('settings-view').classList.contains('hidden')) return 'settings';
            return 'home';
        }
        
        // Test Plan Access (Console Debug)
        window.testPlanAccess = function() {
            console.log('=== PLAN ACCESS TEST ===');
            console.log('Current Plan:', Permissions.currentPlan);
            console.log('Is Premium:', Permissions.isPremium());
            console.log('Is Supporter:', Permissions.isSupporter());
            console.log('Is Legacy+:', Permissions.isLegacy());
            console.log('\n=== FEATURE ACCESS ===');
            
            const testFeatures = ['collections', 'memorial_pages', 'ai_summaries', 'export', 'trailers', 'flowers'];
            testFeatures.forEach(feature => {
                const hasAccess = Permissions.canAccessFeature(feature);
                const required = Permissions.getRequiredPlan(feature);
                console.log(`${feature}: ${hasAccess ? '‚úÖ GRANTED' : '‚ùå DENIED'} (requires: ${required})`);
            });
            
            console.log('\n=== AVAILABLE FEATURES ===');
            const planFeatures = PLAN_FEATURES[Permissions.currentPlan] || [];
            console.log(planFeatures.length > 0 ? planFeatures : 'None');
        };

        // ============================================================================
        // ETERNAL COORDINATES - MapKit 3D Flyover
        // ============================================================================

        // MapKit Token (replaced at runtime or hardcoded for demo)
        const MAPKIT_TOKEN = 'YOUR_MAPKIT_JS_TOKEN_HERE';  // TODO: Replace with actual token

        // EternalFlyover class for cinematic 3D camera movements
        class EternalFlyover {
            constructor(mapElement, coordinates, options = {}) {
                this.mapElement = mapElement;
                this.coordinates = coordinates;
                this.options = {
                    cameraDistance: options.cameraDistance || 800,
                    cameraPitch: options.cameraPitch || 60,
                    rotationSpeed: options.rotationSpeed || 0.1,
                    ...options
                };
                this.isAnimating = false;
                this.animationFrame = null;
                this.map = null;
                this.currentHeading = 0;
            }

            async initialize() {
                // Check if MapKit is available
                if (typeof mapkit === 'undefined') {
                    console.warn('MapKit JS not loaded');
                    return false;
                }

                // Initialize MapKit if needed
                if (!mapkit.isInitialized) {
                    try {
                        await new Promise((resolve, reject) => {
                            mapkit.init({
                                authorizationCallback: (done) => {
                                    done(MAPKIT_TOKEN);
                                },
                                language: 'en'
                            });
                            resolve();
                        });
                    } catch (error) {
                        console.error('MapKit init failed:', error);
                        return false;
                    }
                }

                // Create map
                this.map = new mapkit.Map(this.mapElement, {
                    mapType: mapkit.Map.MapTypes.Hybrid,
                    showsMapTypeControl: false,
                    showsCompass: mapkit.FeatureVisibility.Hidden,
                    showsScale: mapkit.FeatureVisibility.Hidden,
                    isRotationEnabled: true,
                    isScrollEnabled: false,
                    isZoomEnabled: false
                });

                return true;
            }

            startFlyover() {
                if (!this.map) return;

                // Create coordinate
                const coord = new mapkit.Coordinate(
                    this.coordinates.latitude,
                    this.coordinates.longitude
                );

                // Set initial camera position
                const camera = new mapkit.CameraLookAtCenter({
                    centerCoordinate: coord,
                    cameraDistance: this.options.cameraDistance,
                    cameraPitch: this.options.cameraPitch,
                    cameraHeading: 0
                });

                this.map.setCameraBoundary(camera, mapkit.Map.CameraBoundaries.None);
                this.currentHeading = 0;

                // Start rotation animation
                this.isAnimating = true;
                this.rotateCamera();
            }

            rotateCamera() {
                if (!this.isAnimating || !this.map) return;

                const coord = new mapkit.Coordinate(
                    this.coordinates.latitude,
                    this.coordinates.longitude
                );

                const animate = () => {
                    if (!this.isAnimating) return;

                    this.currentHeading += this.options.rotationSpeed;
                    if (this.currentHeading >= 360) this.currentHeading = 0;

                    const camera = new mapkit.CameraLookAtCenter({
                        centerCoordinate: coord,
                        cameraDistance: this.options.cameraDistance,
                        cameraPitch: this.options.cameraPitch,
                        cameraHeading: this.currentHeading
                    });

                    this.map.setCameraBoundary(camera, mapkit.Map.CameraBoundaries.None);
                    this.animationFrame = requestAnimationFrame(animate);
                };

                animate();
            }

            pause() {
                this.isAnimating = false;
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                    this.animationFrame = null;
                }
            }

            resume() {
                if (!this.isAnimating) {
                    this.isAnimating = true;
                    this.rotateCamera();
                }
            }

            stop() {
                this.pause();
                if (this.map) {
                    this.map.destroy();
                    this.map = null;
                }
            }
        }

        // Global reference to active flyover
        window.activeFlyover = null;

        // Open eternal flyover modal
        async function openEternalFlyover(legendData) {
            // Create full-screen modal
            const modal = document.createElement('div');
            modal.id = 'eternal-flyover-modal';
            modal.className = 'flyover-modal';

            modal.innerHTML = `
                <div id="eternal-flyover-container">
                    <div id="eternal-map"></div>
                    
                    <div class="flyover-overlay">
                        <div class="flyover-header">
                            <span class="flyover-icon">‚≠ê</span>
                            <h2 class="flyover-title">Eternal Coordinates</h2>
                        </div>
                        
                        <div class="flyover-info">
                            <p class="flyover-name">${legendData.name}</p>
                            <p class="flyover-location">${legendData.coordinates.site_name}</p>
                            <p class="flyover-city">${legendData.coordinates.city}, ${legendData.coordinates.country}</p>
                        </div>
                        
                        <p class="flyover-description">
                            ${legendData.coordinates.poetic_description}
                        </p>
                        
                        <div class="flyover-actions">
                            <button class="flyover-action" onclick="toggleFlyoverPause()">
                                <span id="play-pause-icon">‚è∏</span> <span id="play-pause-text">Pause</span>
                            </button>
                            <button class="flyover-action" onclick="openCoordinatesInMaps(${legendData.coordinates.latitude}, ${legendData.coordinates.longitude})">
                                üó∫Ô∏è Open in Maps
                            </button>
                        </div>
                    </div>
                    
                    <button class="flyover-close" onclick="closeFlyover()">‚úï</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize flyover
            const coords = {
                latitude: legendData.coordinates.latitude,
                longitude: legendData.coordinates.longitude
            };

            window.activeFlyover = new EternalFlyover(
                document.getElementById('eternal-map'),
                coords
            );

            const initialized = await window.activeFlyover.initialize();

            if (initialized) {
                window.activeFlyover.startFlyover();
            } else {
                // Fallback: Show static message
                document.getElementById('eternal-map').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.6); text-align: center; padding: 40px;">
                        <div>
                            <p style="font-size: 48px; margin-bottom: 20px;">‚≠ê</p>
                            <p>3D Flyover requires MapKit configuration.</p>
                            <p style="margin-top: 10px; font-size: 14px;">Showing location info below.</p>
                        </div>
                    </div>
                `;
            }

            // Fade in
            setTimeout(() => modal.classList.add('active'), 50);
        }

        // Close flyover modal
        function closeFlyover() {
            if (window.activeFlyover) {
                window.activeFlyover.stop();
                window.activeFlyover = null;
            }

            const modal = document.getElementById('eternal-flyover-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Toggle pause/play
        function toggleFlyoverPause() {
            if (!window.activeFlyover) return;

            const icon = document.getElementById('play-pause-icon');
            const text = document.getElementById('play-pause-text');

            if (window.activeFlyover.isAnimating) {
                window.activeFlyover.pause();
                icon.textContent = '‚ñ∂';
                text.textContent = 'Play';
            } else {
                window.activeFlyover.resume();
                icon.textContent = '‚è∏';
                text.textContent = 'Pause';
            }
        }

        // Open in Apple Maps
        function openCoordinatesInMaps(lat, lon) {
            const url = `https://maps.apple.com/?ll=${lat},${lon}&z=16`;
            window.open(url, '_blank');
        }

        // Demo eternal coordinates data (for testing)
        const demoEternalCoordinates = {
            'jim-morrison': {
                site_name: 'P√®re Lachaise',
                city: 'Paris',
                country: 'France',
                latitude: 48.8611,
                longitude: 2.3931,
                poetic_description: 'Among the legends of Paris, Jim Morrison found eternal peace in P√®re Lachaise. His spirit lives on in the hearts of those who believe poetry and music can change the world.'
            },
            'elvis-presley': {
                site_name: 'Graceland',
                city: 'Memphis',
                country: 'United States',
                latitude: 35.0478,
                longitude: -90.0259,
                poetic_description: 'At Graceland, the King of Rock and Roll rests in the home where he created history. His legacy continues to inspire millions who pilgrimage to this musical sacred ground.'
            }
        };

        // Test function to open flyover with demo data
        window.testFlyover = function (legendKey) {
            const coords = demoEternalCoordinates[legendKey];
            if (coords) {
                openEternalFlyover({
                    name: legendKey === 'jim-morrison' ? 'Jim Morrison' : 'Elvis Presley',
                    coordinates: coords
                });
            }
        };

        function journeyRingNavigate(element, action) { document.querySelectorAll('.journey-ring-item').forEach(item => item.classList.remove('active')); element.classList.add('active'); eval(action); }

        function startHeroRotation(data) {
            if (!data || data.length === 0) return;
            const r = data[Math.floor(Math.random() * data.length)];
            updateHero(r);
            if (heroInterval) clearInterval(heroInterval);
            heroInterval = setInterval(() => { if (allLegendsCache.length) { const next = allLegendsCache[Math.floor(Math.random() * allLegendsCache.length)]; updateHero(next); } }, 8000);
        }
        function updateHero(r) { const c = document.getElementById('hero-container'); if (r && c) { c.innerHTML = `<div onclick="openDetail('${r.id}')" class="relative w-full h-full animate-fade-in"><img src="${r.image_url}" class="absolute inset-0 w-full h-full object-cover object-[50%_25%] grayscale transition-all duration-1000"><div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div><div class="absolute bottom-8 left-8"><span class="bg-gold text-black text-[10px] font-bold px-2 py-1 uppercase">Highlight</span><h2 class="text-4xl font-black mt-2 text-white drop-shadow-lg">${r.name}</h2></div></div>`; } }
        async function loadActiveCampaign() { if (Permissions.isPremium()) { document.getElementById('noble-ad-container').classList.add('hidden'); return; } try { const { data, error } = await db.from('campaigns').select('*').eq('active', true).limit(1).single(); if (error || !data) { document.getElementById('noble-ad-container').classList.add('hidden'); return; } activeCampaign = data; renderAdBanner(data); } catch (err) { document.getElementById('noble-ad-container').classList.add('hidden'); } }
        function renderAdBanner(campaign) { const container = document.getElementById('noble-ad-container'); if (!campaign) { container.classList.add('hidden'); return; } container.classList.remove('hidden'); container.innerHTML = `<div class="noble-ad-banner" onclick="window.open('${campaign.target_url}', '_blank')"><div class="noble-ad-bg" style="background-image: url('${campaign.image_url}');"></div><div class="noble-ad-overlay"></div><div class="noble-ad-content"><span class="noble-ad-label">${campaign.sponsor_label || 'SPONSORED TRIBUTE'}</span><h3 class="noble-ad-title">${campaign.title}</h3></div></div>`; }

        function filterCategoryMulti(categories) {
            hideAllViews(); resetHeaders();
            activeFilter = categories[0];
            document.getElementById('home-view').classList.remove('hidden');
            const titleEl = document.getElementById('category-title');
            titleEl.innerText = 'Film & Comedy';
            titleEl.classList.remove('hidden');
            updateNavColors('home');
            
            currentOffset = 0;
            endOfList = false;
            document.getElementById('legends-grid').innerHTML = '';
            
            fetchLegendsMulti(categories);
        }

        async function fetchLegendsMulti(categories) {
            if (isLoading || endOfList) return;
            isLoading = true;

            let allData = [];
            for (const cat of categories) {
                const { data, error } = await db.from('legends').select('*').ilike('category', `%${cat}%`).order('name', { ascending: true });
                if (!error && data) allData = allData.concat(data);
            }

            if (allData.length > 0) {
                allData.forEach(item => {
                    if (!allLegendsCache.find(x => x.id === item.id)) allLegendsCache.push(item);
                });

                const grid = document.getElementById('legends-grid');
                allData.forEach(l => {
                    grid.insertAdjacentHTML('beforeend', createCard(l));
                });
            } else {
                endOfList = true;
                document.getElementById('legends-grid').innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No legends found.</p>';
            }

            isLoading = false;
        }

        // INIT
        loadDevPermission();
        Permissions.init();
        loadUserData();
        showHome();
    </script>
</body>

</html>
